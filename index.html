<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Roroad to Love üåπ</title>
    <!-- Chargement de TailwindCSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Chargement de Tone.js pour les sons -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/tone/14.8.49/Tone.min.js"></script>
    <!-- Polices po√©tiques -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Lora:ital,wght@0,400..700;1,400..700&family=Playfair+Display:ital,wght@0,400..900;1,400..900&display=swap" rel="stylesheet">
    
    <style>
        /* D√©finition des polices et des couleurs de base */
        body {
            font-family: 'Lora', serif;
            background-color: #FFFBF7; /* Blanc cass√© */
            color: #4A2B2B; /* Brun ros√© fonc√© pour le texte */
        }
        h1, h2, h3, .font-display {
            font-family: 'Playfair Display', serif;
        }
        
        /* Couleurs personnalis√©es Tailwind */
        .bg-base { background-color: #FFFBF7; } /* Blanc cass√© */
        .bg-primary { background-color: #FADADD; } /* Rose pastel */
        .bg-secondary { background-color: #F3E5AB; } /* Dor√© doux */
        .text-accent { color: #D4AF37; } /* Or */
        .border-accent { border-color: #F3E5AB; } /* Dor√© doux */
        .btn-primary {
            background-color: #FADADD; /* Rose pastel */
            color: #8B4513; /* Brun */
            transition: all 0.3s ease;
        }
        .btn-primary:hover:not(:disabled) {
            background-color: #F4C2C2; /* Rose plus soutenu */
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0,0,0,0.05);
        }
        .btn-primary:disabled {
            background-color: #FCEEED;
            color: #D1B6B6;
            opacity: 0.7;
            cursor: not-allowed;
        }
        .btn-secondary {
            background-color: #F3E5AB; /* Dor√© */
            color: #8B4513; /* Brun */
            transition: all 0.3s ease;
        }
        .btn-secondary:hover:not(:disabled) {
            background-color: #E9D793;
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0,0,0,0.05);
        }
        .btn-secondary:disabled {
            background-color: #F9F3DE;
            color: #C9BFA0;
            opacity: 0.7;
            cursor: not-allowed;
        }

        /* --- NOUVEAUX TH√àMES --- */
        
        /* Th√®me Romain (Bleu) - MODIFI√â */
        .theme-romain .bg-primary { background-color: #D6EAF8; } /* Bleu pastel */
        .theme-romain .btn-primary {
            background-color: #D6EAF8; /* Bleu pastel */
            color: #1A5276; /* Bleu fonc√© */
        }
        .theme-romain .btn-primary:hover:not(:disabled) {
            background-color: #AED6F1; /* Bleu plus soutenu */
        }
        .theme-romain .btn-primary:disabled {
            background-color: #EBF5FB;
            color: #A9CCE3;
        }
        .theme-romain .text-rose-800 { color: #1A5276; }
        .theme-romain .text-rose-900 { color: #154360; }
        .theme-romain .border-rose-100 { border-color: #D6EAF8; }
        .theme-romain .border-rose-200 { border-color: #AED6F1; }
        .theme-romain .border-rose-300 { border-color: #85C1E9; }
        .theme-romain .bg-rose-50 { background-color: #EBF5FB; }
        .theme-romain .bg-rose-100 { background-color: #D6EAF8; }
        .theme-romain .hover\:bg-rose-100:hover { background-color: #D6EAF8; }
        .theme-romain .hover\:bg-rose-50:hover { background-color: #EBF5FB; }
        .theme-romain .hover\:bg-rose-200:hover { background-color: #AED6F1; }
        .theme-romain .text-rose-700 { color: #1A5276; }
        .theme-romain .text-rose-600 { color: #1F618D; }
        .theme-romain .text-rose-500 { color: #2471A3; }
        .theme-romain .bg-rose-200 { background-color: #AED6F1; }
        .theme-romain .from-rose-300 { --tw-gradient-from: #AED6F1 var(--tw-gradient-from-position); }
        .theme-romain .from-rose-200 { --tw-gradient-from: #D6EAF8 var(--tw-gradient-from-position); }

        /* Th√®me Perla (Rose) - par d√©faut, mais forc√© pour √™tre s√ªr */
        .theme-perla .bg-primary { background-color: #FADADD; }
        .theme-perla .btn-primary { background-color: #FADADD; color: #8B4513; }
        .theme-perla .btn-primary:hover:not(:disabled) { background-color: #F4C2C2; }
        .theme-perla .btn-primary:disabled { background-color: #FCEEED; color: #D1B6B6; }
        .theme-perla .text-rose-800 { color: #9F1239; } /* Utilisation des couleurs tailwind pour rose */
        .theme-perla .text-rose-900 { color: #881337; }
        .theme-perla .border-rose-100 { border-color: #FFE4E6; }
        .theme-perla .border-rose-200 { border-color: #FECDD3; }
        .theme-perla .border-rose-300 { border-color: #FDA4AF; }
        .theme-perla .bg-rose-50 { background-color: #FFF1F2; }
        .theme-perla .bg-rose-100 { background-color: #FFE4E6; }
        .theme-perla .hover\:bg-rose-100:hover { background-color: #FFE4E6; }
        .theme-perla .hover\:bg-rose-50:hover { background-color: #FFF1F2; }
        .theme-perla .hover\:bg-rose-200:hover { background-color: #FECDD3; }
        .theme-perla .text-rose-700 { color: #BE123C; }
        .theme-perla .text-rose-600 { color: #E11D48; }
        .theme-perla .text-rose-500 { color: #F43F5E; }
        .theme-perla .bg-rose-200 { background-color: #FECDD3; }
        .theme-perla .from-rose-300 { --tw-gradient-from: #FDA4AF var(--tw-gradient-from-position); }
        .theme-perla .from-rose-200 { --tw-gradient-from: #FECDD3 var(--tw-gradient-from-position); }

        /* Masquer la scrollbar */
        .no-scrollbar::-webkit-scrollbar { display: none; }
        .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }
        
        /* --- Styles pour la Roue --- */
        .wheel-container {
            width: 100%;
            height: 100px; /* Hauteur d'un item */
            overflow: hidden;
            position: relative;
            border-radius: 12px;
            background: linear-gradient(to bottom, rgba(255,255,255,0.8), rgba(255,255,255,0) 30%, rgba(255,255,255,0) 70%, rgba(255,255,255,0.8));
            border: 2px solid var(--border-color, #FFE4E6); /* Couleur par d√©faut */
            box-shadow: inset 0 0 10px rgba(0,0,0,0.05);
        }
        .theme-romain .wheel-container { --border-color: #D6EAF8; }
        .theme-perla .wheel-container { --border-color: #FFE4E6; }
        
        .wheel-marker {
            position: absolute;
            top: 50%;
            left: 0;
            right: 0;
            height: 50px; /* Hauteur de l'item central */
            transform: translateY(-50%);
            border-top: 2px dashed var(--marker-color, #F43F5E);
            border-bottom: 2px dashed var(--marker-color, #F43F5E);
            z-index: 10;
        }
        .theme-romain .wheel-marker { --marker-color: #2471A3; }
        .theme-perla .wheel-marker { --marker-color: #F43F5E; }

        .wheel-inner {
            transition: transform 3s cubic-bezier(0.25, 0.1, 0.25, 1);
            position: relative;
            z-index: 5;
        }
        .wheel-item {
            height: 50px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.5rem; /* 24px */
            font-weight: bold;
        }
        
        /* NOUVEAU: Animation de c≈ìur qui bat */
        @keyframes beat {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.1); }
        }
        .heart-beat {
            animation: beat 1.5s infinite ease-in-out;
        }

        /* NOUVEAU: Animation "flashy" dor√©e */
        @keyframes gold-pulse {
            0%, 100% {
                box-shadow: 0 4px 12px rgba(233, 180, 16, 0.4);
                transform: scale(1);
            }
            50% {
                box-shadow: 0 6px 20px rgba(233, 180, 16, 0.7);
                transform: scale(1.03);
            }
        }
        .btn-gold-flashy {
            /* D√©grad√© dor√© brillant */
            background: linear-gradient(180deg, #FDEE8A 0%, #F3E5AB 40%, #E9B410 100%);
            color: #6D4C41; /* Brun fonc√© pour le texte */
            border: 2px solid #E6A900;
            transition: all 0.3s ease;
            /* Animation "flashy" */
            animation: gold-pulse 2.5s infinite ease-in-out;
        }
        .btn-gold-flashy:hover:not(:disabled) {
            transform: scale(1.05) translateY(-2px); /* Effet de survol plus prononc√© */
            box-shadow: 0 6px 20px rgba(233, 180, 16, 0.7);
        }
    </style>
</head>

<body class="bg-base">

    <!-- Conteneur principal de l'application (format mobile) -->
    <div class="max-w-md mx-auto min-h-screen shadow-2xl bg-white overflow-hidden">
        
        <!-- Conteneur pour les diff√©rentes vues -->
        <div id="app-container" class="relative w-full h-full">

            <!-- ======================================= -->
            <!--            Vue 0: LOGIN                 -->
            <!-- ======================================= -->
            <!-- CORRECTION: Attribut `class.bind` invalide retir√© -->
            <div id="view-login" class="p-6 pt-20 h-screen flex flex-col justify-center text-center">
                <h1 class="font-display text-4xl font-bold text-rose-800">Roroad to Love</h1>
                <p class="mt-4 text-lg text-gray-600 mb-12">Qui reprend la route ?</p>
                
                <div class="space-y-6">
                    <!-- MODIFI√â: Ic√¥nes et login 'perla' -->
                    <button onclick="login('perla')" class="w-full p-6 rounded-2xl shadow-lg bg-primary hover:bg-rose-200 transition-all">
                        <span class="text-6xl">üë©üèª‚Äçüî¨</span>
                        <span class="block font-display text-3xl font-bold text-rose-800 mt-2">Perla</span>
                    </button>
                    
                    <!-- MODIFI√â: Ic√¥nes et login 'romain' -->
                    <button onclick="login('romain')" class="w-full p-6 rounded-2xl shadow-lg bg-blue-100 hover:bg-blue-200 transition-all">
                        <span class="text-6xl">üë®üèª‚Äçüíº</span>
                        <span class="block font-display text-3xl font-bold text-blue-800 mt-2">Romain</span>
                    </button>
                </div>
            </div>

            <!-- ======================================= -->
            <!--            Vue 1: ACCUEIL               -->
            <!-- ======================================= -->
            <div id="view-home" class="p-6 pt-10 hidden">
                <header class="text-center mb-8">
                    <h1 class="font-display text-3xl font-bold text-rose-800">Roroad to Love</h1>
                    <p class="mt-4 text-lg text-gray-600">
                        Bienvenue, <span id="home-welcome-name" class="font-bold"></span> üíû<br>
                        <span class="text-base italic">Pr√™ts √† reprendre la route de l‚Äôamour ?</span>
                    </p>
                </header>

                <!-- NOUVEAU: Progression des Joueurs -->
                <div class="mb-6 space-y-4">
                    <h3 class="font-display text-xl text-rose-800 text-center mb-2">Progression üåπ Reset Love</h3>
                    
                    <!-- Progression Perla -->
                    <div>
                        <div class="flex justify-between items-center mb-1">
                            <!-- MODIFI√â: Ic√¥ne -->
                            <span class="text-sm font-semibold text-rose-700">Perla üíÉüèª</span>
                            <span class="text-sm text-gray-500"><span id="home-progress-text-perla">0</span> / 100 üíï</span>
                        </div>
                        <div class="w-full bg-gray-200 rounded-full h-4">
                            <div id="home-progress-bar-perla" class="bg-gradient-to-r from-rose-300 to-pink-400 h-4 rounded-full transition-all duration-500" style="width: 0%;"></div>
                        </div>
                    </div>
        
                    <!-- Progression Romain -->
                    <div>
                        <div class="flex justify-between items-center mb-1">
                            <!-- MODIFI√â: Ic√¥ne et ID -->
                            <span class="text-sm font-semibold text-blue-700">Romain üï∫üèª</span>
                            <span class="text-sm text-gray-500"><span id="home-progress-text-romain">0</span> / 100 üíï</span>
                        </div>
                        <div class="w-full bg-gray-200 rounded-full h-4">
                            <div id="home-progress-bar-romain" class="bg-gradient-to-r from-blue-300 to-blue-400 h-4 rounded-full transition-all duration-500" style="width: 0%;"></div>
                        </div>
                    </div>
                </div>


                <!-- Banque d'Amour Solde (reste personnel) -->
                <div class="mb-8 text-center bg-primary p-4 rounded-xl shadow-inner">
                    <h3 class="text-sm font-semibold text-rose-800 opacity-75">Banque d'Amour üè¶</h3>
                    <!-- CORRECTION: Ajout du <p> et <span> manquant -->
                    <p class="text-4xl font-bold text-rose-900"><span id="home-love-bank">0</span> üíï</p>
                </div>
                
                <!-- Boutons de navigation principaux (GRILLE MISE √Ä JOUR 3x3) -->
                <nav class="grid grid-cols-3 gap-3">
                    <button onclick="showView('new-mission')" class="btn-primary p-3 rounded-xl shadow-lg flex flex-col items-center justify-center h-28">
                        <span class="text-3xl">üé≤</span>
                        <span class="font-semibold text-xs text-center">Nouvelle Mission</span>
                    </button>
                    <button id="ongoing-mission-btn" onclick="showView('ongoing-mission')" class="btn-primary p-3 rounded-xl shadow-lg flex flex-col items-center justify-center h-28">
                        <span class="text-3xl">üéØ</span>
                        <span class="font-semibold text-xs text-center">Mission en Cours</span>
                    </button>
                    <button onclick="showView('bank')" class="btn-primary p-3 rounded-xl shadow-lg flex flex-col items-center justify-center h-28">
                        <span class="text-3xl">üè¶</span>
                        <span class="font-semibold text-xs text-center">Banque d'Amour</span>
                    </button>
                    <!-- MODIFI√â: Remplacement de btn-secondary par btn-gold-flashy -->
                    <button onclick="showView('timeline')" class="p-3 rounded-xl shadow-lg flex flex-col items-center justify-center h-28 btn-gold-flashy">
                        <span class="text-3xl">üõ£Ô∏è</span>
                        <span class="font-semibold text-xs text-center">L'Aventure A ‚Üí Z</span>
                    </button>
                    <button onclick="showView('cards')" class="btn-primary p-3 rounded-xl shadow-lg flex flex-col items-center justify-center h-28">
                        <span class="text-3xl">üé¥</span>
                        <span class="font-semibold text-xs text-center">Cartes Sp√©ciales</span>
                    </button>
                    <button onclick="showView('jokers')" class="btn-primary p-3 rounded-xl shadow-lg flex flex-col items-center justify-center h-28">
                        <span class="text-3xl">üíé</span>
                        <span class="font-semibold text-xs text-center">Jokers</span>
                    </button>
                    <button onclick="showView('mailbox')" class="btn-primary p-3 rounded-xl shadow-lg flex flex-col items-center justify-center h-28">
                        <span class="text-3xl">üì¨</span>
                        <span class="font-semibold text-xs text-center">Boite aux Lettres</span>
                    </button>
                    <!-- NOUVEAU BOUTON "Galerie" -->
                    <button onclick="showView('gallery')" class="btn-primary p-3 rounded-xl shadow-lg flex flex-col items-center justify-center h-28">
                        <span class="text-3xl">üñºÔ∏è</span>
                        <span class="font-semibold text-xs text-center">Galerie Photos</span>
                    </button>
                    <button onclick="logout()" class="btn-primary p-3 rounded-xl shadow-lg flex flex-col items-center justify-center h-28">
                        <span class="text-3xl">üîÑ</span>
                        <span class="font-semibold text-xs text-center">Changer de Joueur</span>
                    </button>
                </nav>

                <!-- Derniers souvenirs -->
                <div class="mt-8">
                    <h3 class="font-display text-xl text-rose-800 mb-3">Derniers Souvenirs</h3>
                    <div id="home-souvenirs" class="flex gap-3 overflow-x-auto no-scrollbar pb-2">
                        <!-- Les souvenirs seront inject√©s ici par JS -->
                        <p class="text-sm text-gray-500 italic">Commencez une mission pour ajouter un souvenir...</p>
                    </div>
                </div>
            </div>

            <!-- ======================================= -->
            <!--    Vue NOUVELLE MISSION (LA ROUE)       -->
            <!-- ======================================= -->
            <div id="view-new-mission" class="p-6 hidden">
                <header class="flex items-center mb-6">
                    <button onclick="showView('home')" class="text-2xl p-2 rounded-full hover:bg-rose-100">‚Üê</button>
                    <h2 class="font-display text-2xl font-bold text-rose-800 text-center flex-1">Nouvelle Mission</h2>
                </header>
                
                <p class="text-center text-gray-600 mb-6 italic">Pr√™ts pour un nouveau d√©fi ? Laissez le destin choisir...</p>

                <!-- Roue des Missions (Lettres) -->
                <div class="mb-6">
                    <h3 class="font-display text-xl text-rose-800 mb-2 text-center">1. Quelle mission ?</h3>
                    <div class="wheel-container">
                        <div class="wheel-marker"></div>
                        <div id="wheel-letter" class="wheel-inner text-rose-800">
                            <!-- Les lettres A-Z seront inject√©es ici -->
                        </div>
                    </div>
                </div>

                <!-- Roue des Modes de Jeu -->
                <div class="mb-8">
                    <h3 class="font-display text-xl text-rose-800 mb-2 text-center">2. Quel mode ?</h3>
                    <div class="wheel-container">
                        <div class="wheel-marker"></div>
                        <div id="wheel-mode" class="wheel-inner text-rose-800">
                             <!-- Les modes de jeu seront inject√©s ici -->
                        </div>
                    </div>
                </div>

                <div class="space-y-3">
                    <button id="spin-button" onclick="spinWheels()" class="btn-secondary w-full p-4 rounded-xl shadow-lg text-lg font-bold">
                        Lancer les roues üé≤
                    </button>
                </div>
            </div>

            <!-- ======================================= -->
            <!--    Vue BRIEFING MISSION (NOUVEAU)       -->
            <!-- ======================================= -->
            <div id="view-mission-briefing" class="p-6 hidden">
                <header class="flex items-center mb-6">
                    <button onclick="showView('home')" class="text-2xl p-2 rounded-full hover:bg-rose-100">‚Üê</button>
                    <h2 class="font-display text-2xl font-bold text-rose-800 text-center flex-1">Mission Lanc√©e !</h2>
                </header>
                
                <div class="text-center mb-6">
                    <span class="text-7xl">üìú</span>
                    <h3 class="font-display text-3xl text-rose-800 mt-4" id="briefing-title">A: Aventure</h3>
                </div>

                <div class="bg-rose-50 p-4 rounded-lg mb-6 shadow-inner">
                    <h4 class="font-semibold text-rose-800 mb-2">Description de la mission :</h4>
                    <p class="text-gray-700" id="briefing-description">...</p>
                </div>

                <div class="bg-yellow-50 p-4 rounded-lg mb-8 shadow-inner border border-yellow-200">
                    <h4 class="font-semibold text-rose-800 mb-2">Mode de jeu assign√© :</h4>
                    <p class="text-lg font-bold text-rose-900 mb-2" id="briefing-mode">...</p>
                    <p class="text-sm text-gray-700" id="briefing-mode-explanation">...</p>
                </div>

                <button onclick="showView('home')" class="btn-primary w-full p-4 rounded-xl shadow-lg text-lg font-bold">
                    Compris ! (Retour √† l'accueil)
                </button>
            </div>
            
            <!-- ======================================= -->
            <!--    Vue MISSION EN COURS       -->
            <!-- ======================================= -->
            <div id="view-ongoing-mission" class="p-6 hidden">
                <header class="flex items-center mb-6">
                    <button onclick="showView('home')" class="text-2xl p-2 rounded-full hover:bg-rose-100">‚Üê</button>
                    <h2 class="font-display text-2xl font-bold text-rose-800 text-center flex-1" id="mission-ongoing-title">Mission en Cours</h2>
                </header>

                <!-- Message si aucune mission -->
                <div id="no-ongoing-mission" class="text-center p-6 bg-rose-50 rounded-lg hidden">
                    <span class="text-4xl">ü§∑‚Äç‚ôÄÔ∏è</span>
                    <p class="mt-4 text-gray-700 font-semibold">Aucune mission en cours.</p>
                    <p class="text-sm text-gray-500 mt-2">Allez √† "Nouvelle Mission" pour en lancer une !</p>
                    <button onclick="showView('new-mission')" class="btn-primary mt-4 px-4 py-2">Lancer une mission</button>
                </div>
                
                <!-- Contenu de la mission en cours -->
                <div id="ongoing-mission-content">
                    <div class="bg-primary p-4 rounded-xl shadow-inner mb-4">
                        <h3 class="font-semibold text-rose-800">Mode de jeu</h3>
                        <p class="text-lg font-bold text-rose-900" id="mission-ongoing-mode">Duo</p>
                        <!-- NOUVEL AJOUT: Explication du mode de jeu -->
                        <p class="text-sm text-rose-800 opacity-90 mt-2" id="mission-ongoing-mode-explanation"></p>
                    </div>
                    
                    <div class="mb-4">
                        <h3 class="font-semibold text-rose-800 mb-2">Description</h3>
                        <p class="text-gray-700" id="mission-ongoing-description">Une description du th√®me de la mission...</p>
                    </div>

                    <div class="mb-4">
                        <h3 class="font-semibold text-rose-800 mb-2">Souvenir</h3>
                        <img id="mission-ongoing-photo-preview" src="https://placehold.co/600x400/FADADD/8B4513?text=Ajouter+une+photo" alt="Souvenir" class="w-full rounded-lg shadow-md object-cover h-48 mb-2">
                        <input type="file" class="text-sm" onchange="previewMissionPhoto(event)">
                    </div>
                    
                    <div class="mb-4">
                        <h3 class="font-semibold text-rose-800 mb-2">Note souvenir</h3>
                        <textarea id="mission-ongoing-note" class="w-full p-2 border border-rose-200 rounded-lg" rows="3" placeholder="√âcrivez un petit mot sur ce moment..."></textarea>
                    </div>

                    <!-- NOUVELLE SECTION: Bonus Actifs -->
                    <div class="mb-6">
                        <h3 class="font-semibold text-rose-800 mb-2">Bonus Actifs</h3>
                        <div id="ongoing-mission-bonuses" class="p-4 bg-rose-50 rounded-lg space-y-2 min-h-[40px]">
                            <!-- Les bonus actifs seront inject√©s ici -->
                            <p class="text-sm text-gray-500 italic">Aucun bonus actif pour cette mission.</p>
                        </div>
                    </div>

                    <div class="mb-6">
                        <h3 class="font-semibold text-rose-800 mb-2">Ajouter des Bonus</h3>
                        <div class="grid grid-cols-2 gap-3">
                            <button onclick="showView('cards')" class="btn-primary p-3 rounded-lg text-sm font-semibold">Ajouter Carte üé¥</button>
                            <button onclick="showView('jokers')" class="btn-primary p-3 rounded-lg text-sm font-semibold">Ajouter Joker üíé</button>
                        </div>
                    </div>

                    <button onclick="goToScoringFromOngoing()" id="goto-scoring-button-ongoing" class="btn-secondary w-full p-4 rounded-xl shadow-lg text-lg font-bold">
                        Terminer & Noter la Mission üßÆ
                    </button>
                </div>
            </div>


            <!-- ======================================= -->
            <!--         Vue: TIMELINE (A-Z)             -->
            <!-- ======================================= -->
            <div id="view-timeline" class="p-6 hidden">
                <header class="flex items-center mb-6">
                    <button onclick="showView('home')" class="text-2xl p-2 rounded-full hover:bg-rose-100">‚Üê</button>
                    <h2 class="font-display text-2xl font-bold text-rose-800 text-center flex-1">Roroad A ‚Üí Z</h2>
                </header>

                <div class="grid grid-cols-4 gap-4" id="timeline-grid">
                    <!-- Les bulles de mission seront inject√©es ici par JS -->
                </div>
                
                <!-- Bulle Reset Love -->
                <div class="mt-6 flex justify-center">
                    <button onclick="tryShowResetLove()" class="w-24 h-24 rounded-full flex flex-col items-center justify-center text-center shadow-lg border-2 border-yellow-300 pulse-gold bg-gradient-to-br from-yellow-300 to-rose-300">
                        <span class="text-4xl">üåπ</span>
                        <span class="text-xs font-bold text-rose-900">Reset Love</span>
                    </button>
                </div>
            </div>

            <!-- ======================================= -->
            <!--         Vue: FICHE MISSION (Vitrine)    -->
            <!-- ======================================= -->
            <div id="view-mission" class="p-6 hidden">
                <header class="flex items-center mb-6">
                    <!-- NOUVEAU: Le bouton retour renvoie √† la Timeline -->
                    <button onclick="showView('timeline')" class="text-2xl p-2 rounded-full hover:bg-rose-100">‚Üê</button>
                    <h2 class="font-display text-2xl font-bold text-rose-800 text-center flex-1" id="mission-title">A: Aventure</h2>
                </header>

                <div class="bg-primary p-4 rounded-xl shadow-inner mb-4">
                    <h3 class="font-semibold text-rose-800">Mode de jeu</h3>
                    <p class="text-lg font-bold text-rose-900" id="mission-mode">Duo</p>
                </div>
                
                <div class="mb-4">
                    <h3 class="font-semibold text-rose-800 mb-2">Description</h3>
                    <p class="text-gray-700" id="mission-description">Une description du th√®me de la mission...</p>
                </div>

                <div class="mb-4">
                    <h3 class="font-semibold text-rose-800 mb-2">Souvenir</h3>
                    <img id="mission-photo-preview" src="https://placehold.co/600x400/FADADD/8B4513?text=Ajouter+une+photo" alt="Souvenir" class="w-full rounded-lg shadow-md object-cover h-48 mb-2">
                    <input type="file" class="text-sm" onchange="previewMissionPhoto(event)">
                </div>
                
                <div class="mb-4">
                    <h3 class="font-semibold text-rose-800 mb-2">Note souvenir</h3>
                    <textarea id="mission-note" class="w-full p-2 border border-rose-200 rounded-lg" rows="3" placeholder="√âcrivez un petit mot sur ce moment..."></textarea>
                </div>

                <div class="mb-6">
                    <h3 class="font-semibold text-rose-800 mb-2">Statut</h3>
                    <div class="flex gap-2" id="mission-status-buttons">
                        <!-- Boutons de statut inject√©s par JS -->
                    </div>
                </div>

                <!-- Bouton "Noter" est cach√© par d√©faut, car c'est une vitrine -->
                <button onclick="showScoringScreen()" id="goto-scoring-button" class="btn-secondary w-full p-4 rounded-xl shadow-lg text-lg font-bold hidden">
                    Noter la Mission üßÆ
                </button>
            </div>
            
            <!-- ======================================= -->
            <!--          Vue: √âCRAN SCORE               -->
            <!-- ======================================= -->
            <div id="view-score" class="p-6 hidden">
                <header class="flex items-center mb-6">
                    <!-- NOUVEAU: Le bouton retour renvoie √† la mission en cours -->
                    <button onclick="showView('ongoing-mission')" class="text-2xl p-2 rounded-full hover:bg-rose-100">‚Üê</button>
                    <h2 class="font-display text-2xl font-bold text-rose-800 text-center flex-1">Noter la Mission</h2>
                </header>
                
                <p class="text-center text-gray-600 mb-6 italic">Comment s'est pass√© ce moment ? (1-5)</p>
                
                <!-- Crit√®res -->
                <div class="space-y-4 mb-6">
                    <!-- Cr√©ativit√© -->
                    <div>
                        <h3 class="text-lg font-semibold text-rose-800 mb-2">üí° Cr√©ativit√©</h3>
                        <div id="stars-creativite" class="flex justify-between text-4xl text-yellow-400">
                            <span onclick="setRating('creativite', 1)" data-value="1" class="cursor-pointer opacity-30">‚òÖ</span>
                            <span onclick="setRating('creativite', 2)" data-value="2" class="cursor-pointer opacity-30">‚òÖ</span>
                            <span onclick="setRating('creativite', 3)" data-value="3" class="cursor-pointer opacity-30">‚òÖ</span>
                            <span onclick="setRating('creativite', 4)" data-value="4" class="cursor-pointer opacity-30">‚òÖ</span>
                            <span onclick="setRating('creativite', 5)" data-value="5" class="cursor-pointer opacity-30">‚òÖ</span>
                        </div>
                    </div>
                    <!-- Effort -->
                    <div>
                        <h3 class="text-lg font-semibold text-rose-800 mb-2">‚ù§Ô∏è Effort & Intention</h3>
                        <div id="stars-effort" class="flex justify-between text-4xl text-yellow-400">
                            <span onclick="setRating('effort', 1)" data-value="1" class="cursor-pointer opacity-30">‚òÖ</span>
                            <span onclick="setRating('effort', 2)" data-value="2" class="cursor-pointer opacity-30">‚òÖ</span>
                            <span onclick="setRating('effort', 3)" data-value="3" class="cursor-pointer opacity-30">‚òÖ</span>
                            <span onclick="setRating('effort', 4)" data-value="4" class="cursor-pointer opacity-30">‚òÖ</span>
                            <span onclick="setRating('effort', 5)" data-value="5" class="cursor-pointer opacity-30">‚òÖ</span>
                        </div>
                    </div>
                    <!-- Complicit√© -->
                    <div>
                        <h3 class="text-lg font-semibold text-rose-800 mb-2">üòç Complicit√©</h3>
                        <div id="stars-complicite" class="flex justify-between text-4xl text-yellow-400">
                            <span onclick="setRating('complicite', 1)" data-value="1" class="cursor-pointer opacity-30">‚òÖ</span>
                            <span onclick="setRating('complicite', 2)" data-value="2" class="cursor-pointer opacity-30">‚òÖ</span>
                            <span onclick="setRating('complicite', 3)" data-value="3" class="cursor-pointer opacity-30">‚òÖ</span>
                            <span onclick="setRating('complicite', 4)" data-value="4" class="cursor-pointer opacity-30">‚òÖ</span>
                            <span onclick="setRating('complicite', 5)" data-value="5" class="cursor-pointer opacity-30">‚òÖ</span>
                        </div>
                    </div>
                </div>

                <!-- Bonus -->
                <div class="mb-6">
                    <h3 class="text-lg font-semibold text-rose-800 mb-2">üåü Bonus Optionnels</h3>
                    <div class="space-y-2 bg-rose-50 p-4 rounded-lg">
                        <label class="flex items-center"><input type="checkbox" id="bonus-photo" class="mr-2"> Photo souvenir (+1)</label>
                        <label class="flex items-center"><input type="checkbox" id="bonus-surprise" class="mr-2"> Surprise cach√©e (+1)</label>
                        <label class="flex items-center"><input type="checkbox" id="bonus-ambiance" class="mr-2"> Ambiance parfaite (+2)</label>
                        <label class="flex items-center"><input type="checkbox" id="bonus-twist" class="mr-2"> Mission twist√©e (+2)</label>
                        <label class="flex items-center"><input type="checkbox" id="bonus-express" class="mr-2"> Mission express (+1)</label>
                    </div>
                </div>
                
                <!-- Info Jokers/Cartes -->
                <div id="score-bonus-info" class="text-center text-accent font-semibold mb-4">
                    <!-- Info sur bonus actifs -->
                </div>

                <button onclick="calculateScore()" class="btn-secondary w-full p-4 rounded-xl shadow-lg text-lg font-bold">
                    Valider le Score
                </button>
            </div>
            
            <!-- ======================================= -->
            <!--        Vue: BANQUE D'AMOUR              -->
            <!-- ======================================= -->
            <div id="view-bank" class="p-6 hidden">
                <header class="flex items-center mb-6">
                    <button onclick="showView('home')" class="text-2xl p-2 rounded-full hover:bg-rose-100">‚Üê</button>
                    <h2 class="font-display text-2xl font-bold text-rose-800 text-center flex-1">Banque d'Amour üè¶</h2>
                </header>

                <div class="mb-6 text-center bg-primary p-6 rounded-xl shadow-inner">
                    <h3 class="text-lg font-semibold text-rose-800 opacity-75">Solde Actuel</h3>
                    <p class="text-5xl font-bold text-rose-900"><span id="bank-total-points">0</span> üíï</p>
                </div>
                
                <!-- Progression Reset Love -->
                <div class="mb-6">
                    <div class="flex justify-between items-center mb-2">
                        <span class="text-sm font-semibold text-rose-700">Progression</span>
                        <span class="text-lg font-bold text-accent">üåπ Reset Love</span>
                    </div>
                    <div class="w-full bg-gray-200 rounded-full h-4">
                        <div id="bank-progress-bar" class="bg-gradient-to-r from-rose-300 to-yellow-400 h-4 rounded-full transition-all duration-500" style="width: 0%;"></div>
                    </div>
                    <div class="text-right mt-1 text-sm text-gray-500"><span id="bank-progress-text">0</span> / 100 üíï</div>
                </div>
                
                <!-- NOUVELLE SECTION: Inventaire des r√©compenses -->
                <h3 class="font-display text-xl text-rose-800 mb-4">Vos R√©compenses √† Utiliser üéÅ</h3>
                <div class="space-y-3 mb-8" id="purchased-rewards-inventory">
                    <p class="text-sm text-gray-500 italic text-center p-4 bg-gray-50 rounded-lg">Aucune r√©compense en attente. Achetez-en une ci-dessous !</p>
                    <!-- L'inventaire sera inject√© ici -->
                </div>

                <!-- MODIFI√â: Titre de la boutique -->
                <h3 class="font-display text-xl text-rose-800 mb-4">Acheter des R√©compenses üõçÔ∏è</h3>
                <div class="space-y-3" id="rewards-list">
                    <!-- Liste des r√©compenses inject√©e par JS -->
                </div>
            </div>
            
            <!-- ======================================= -->
            <!--       Vue: CARTES SP√âCIALES             -->
            <!-- ======================================= -->
            <div id="view-cards" class="p-6 hidden">
                <header class="flex items-center mb-6">
                    <!-- CORRECTION: Utilisation de la nouvelle fonction goBack() -->
                    <button onclick="goBack()" class="text-2xl p-2 rounded-full hover:bg-rose-100">‚Üê</button>
                    <h2 class="font-display text-2xl font-bold text-rose-800 text-center flex-1">Cartes Sp√©ciales üé¥</h2>
                </header>
                
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4" id="cards-grid">
                    <!-- Cartes inject√©es par JS -->
                </div>
            </div>

            <!-- ======================================= -->
            <!--            Vue: JOKERS                  -->
            <!-- ======================================= -->
            <div id="view-jokers" class="p-6 hidden">
                <header class="flex items-center mb-6">
                    <!-- CORRECTION: Utilisation de la nouvelle fonction goBack() -->
                    <button onclick="goBack()" class="text-2xl p-2 rounded-full hover:bg-rose-100">‚Üê</button>
                    <h2 class="font-display text-2xl font-bold text-rose-800 text-center flex-1">Jokers üíé</h2>
                </header>
                
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4" id="jokers-grid">
                    <!-- Jokers inject√©es par JS -->
                </div>
            </div>

            <!-- ======================================= -->
            <!--        Vue: RESET LOVE üåπ              -->
            <!-- ======================================= -->
            <div id="view-reset-love" class="p-6 h-screen flex flex-col justify-center text-center bg-gradient-to-br from-rose-200 to-yellow-200 hidden">
                <span class="text-7xl mb-6">üåπ</span>
                <h1 class="font-display text-4xl font-bold text-rose-900">Reset Love</h1>
                <p class="mt-4 text-lg text-rose-800 italic">"Chaque aventure a sa fin, mais la n√¥tre recommence √† chaque battement de c≈ìur."</p>
                
                <p class="mt-8 mb-6 text-gray-700">F√©licitations ! Vous avez atteint l'apoth√©ose. Choisissez votre exp√©rience finale pour cette saison :</p>
                
                <div class="space-y-3 mb-8">
                    <button class="w-full p-3 bg-white/70 rounded-lg font-semibold text-rose-800 border border-white">üíå Lettre miroir</button>
                    <button class="w-full p-3 bg-white/70 rounded-lg font-semibold text-rose-800 border border-white">üéÅ Souvenir √©ternel</button>
                    <button class="w-full p-3 bg-white/70 rounded-lg font-semibold text-rose-800 border border-white">üåÖ Voyage symbolique</button>
                    <button class="w-full p-3 bg-white/70 rounded-lg font-semibold text-rose-800 border border-white">üíç Promesse Roroad</button>
                </div>
                
                <button onclick="completeResetLove()" class="btn-secondary w-full p-4 rounded-xl shadow-lg text-lg font-bold">
                    Commencer une nouvelle saison
                </button>
            </div>
            
            <!-- ======================================= -->
            <!--   NOUVELLE VUE: Lettre d'Amour üíå     -->
            <!-- ======================================= -->
            <div id="view-love-letter" class="p-6 hidden bg-gradient-to-br from-rose-100 to-rose-50 min-h-screen">
                <header class="flex items-center mb-6">
                    <button onclick="goBack()" class="text-2xl p-2 rounded-full hover:bg-rose-100">‚Üê</button>
                    <h2 class="font-display text-2xl font-bold text-rose-800 text-center flex-1">Lettre d'Amour</h2>
                </header>
                
                <div class="text-center mb-6">
                    <span class="text-7xl heart-beat">üíå</span>
                    <p class="text-lg text-rose-700 italic mt-4">"Les mots d'amour sont des tr√©sors..."</p>
                </div>
                
                <p class="text-gray-700 mb-4">Cette carte remplace votre mission actuelle par l'√©criture d'une lettre d'amour. Prenez votre temps.</p>
                
                <div>
                    <textarea id="love-letter-text" class="w-full p-4 border border-rose-200 rounded-lg text-lg" rows="12" placeholder="√âcrivez votre lettre ici..."></textarea>
                </div>
                
                <button onclick="sendLoveLetter()" class="btn-secondary w-full p-4 rounded-xl shadow-lg text-lg font-bold mt-6">
                    Envoyer la Lettre
                </button>
            </div>

            <!-- ======================================= -->
            <!--   NOUVELLE VUE: Boite aux Lettres üì¨    -->
            <!-- ======================================= -->
            <div id="view-mailbox" class="p-6 hidden">
                <header class="flex items-center mb-6">
                    <button onclick="showView('home')" class="text-2xl p-2 rounded-full hover:bg-rose-100">‚Üê</button>
                    <h2 class="font-display text-2xl font-bold text-rose-800 text-center flex-1">Boite aux Lettres üì¨</h2>
                </header>
                
                <div id="mailbox-log" class="space-y-4">
                    <!-- Le journal des actions sera inject√© ici -->
                    <p class="text-center text-gray-500 italic p-8">Votre histoire commence ici... Lancez une mission !</p>
                </div>
            </div>

            <!-- ======================================= -->
            <!-- NOUVELLE VUE: Steal My Heart üî• -->
            <!-- ======================================= -->
            <div id="view-steal-reward" class="p-6 hidden">
                <header class="flex items-center mb-6">
                    <button onclick="goBack()" class="text-2xl p-2 rounded-full hover:bg-rose-100">‚Üê</button>
                    <h2 class="font-display text-2xl font-bold text-rose-800 text-center flex-1">Steal My Heart üî•</h2>
                </header>
                
                <p class="text-center text-gray-600 mb-6 italic">Choisissez une r√©compense √† voler dans l'inventaire de votre partenaire...</p>

                <div id="steal-reward-list" class="space-y-3">
                    <!-- Les r√©compenses √† voler seront inject√©es ici -->
                </div>
            </div>
            
            <!-- ======================================= -->
            <!-- NOUVELLE VUE: Galerie Photos üñºÔ∏è -->
            <!-- ======================================= -->
            <div id="view-gallery" class="p-6 hidden">
                <header class="flex items-center mb-6">
                    <button onclick="goBack()" class="text-2xl p-2 rounded-full hover:bg-rose-100">‚Üê</button>
                    <h2 class="font-display text-2xl font-bold text-rose-800 text-center flex-1">Galerie Photos üñºÔ∏è</h2>
                </header>
                
                <div id="gallery-grid" class="grid grid-cols-3 gap-2">
                    <!-- Les photos seront inject√©es ici -->
                </div>
                <div id="gallery-empty" class="text-center p-6 bg-rose-50 rounded-lg hidden">
                    <span class="text-4xl">ü§∑‚Äç‚ôÄÔ∏è</span>
                    <p class="mt-4 text-gray-700 font-semibold">Aucune photo dans la galerie.</p>
                    <p class="text-sm text-gray-500 mt-2">Terminez une mission avec une photo pour la voir appara√Ætre ici !</S>
                </div>
            </div>


        </div> <!-- Fin de #app-container -->

        <!-- ======================================= -->
        <!--           MODAL (pour alertes)          -->
        <!-- ======================================= -->
        <div id="modal-overlay" class="hidden fixed inset-0 bg-black/50 backdrop-blur-sm flex items-center justify-center p-6 z-40">
            <div class="bg-base p-6 rounded-2xl shadow-xl max-w-sm w-full text-center">
                <span id="modal-icon" class="text-5xl">üíñ</span>
                <h3 id="modal-title" class="font-display text-2xl text-rose-800 mt-4 mb-2">Modal Title</h3>
                <p id="modal-message" class="text-gray-700 mb-6">This is the modal message.</p>
                <button id="modal-close-btn" class="btn-primary px-6 py-2 rounded-lg font-semibold">Fermer</button>
            </div>
        </div>

        <!-- ======================================= -->
        <!--   MODAL Rachat Joker (NOUVEAU)        -->
        <!-- ======================================= -->
        <div id="joker-repurchase-modal" class="hidden fixed inset-0 bg-black/50 backdrop-blur-sm flex items-center justify-center p-6 z-50">
            <div class="bg-base p-6 rounded-2xl shadow-xl max-w-sm w-full text-center">
                <span class="text-5xl">üíé</span>
                <h3 class="font-display text-2xl text-rose-800 mt-4 mb-2">Racheter un Joker</h3>
                <p class="text-gray-700 mb-6">Lequel souhaitez-vous r√©activer ? (Co√ªt: 40 üíï)</p>
                <div id="joker-repurchase-list" class="space-y-3 mb-6">
                    <!-- Les jokers utilis√©s seront inject√©s ici -->
                </div>
                <button onclick="closeJokerRepurchaseModal()" class="bg-gray-200 text-gray-700 px-6 py-2 rounded-lg font-semibold">Annuler</button>
            </div>
        </div>

        <!-- ======================================= -->
        <!--   NOUVEAU: MODAL Rachat Carte           -->
        <!-- ======================================= -->
        <div id="card-repurchase-modal" class="hidden fixed inset-0 bg-black/50 backdrop-blur-sm flex items-center justify-center p-6 z-50">
            <div class="bg-base p-6 rounded-2xl shadow-xl max-w-sm w-full text-center">
                <span class="text-5xl">üé¥</span>
                <h3 class="font-display text-2xl text-rose-800 mt-4 mb-2">Racheter une Carte</h3>
                <p class="text-gray-700 mb-6">Laquelle souhaitez-vous r√©activer ? (Co√ªt: 20 üíï)</p>
                <div id="card-repurchase-list" class="space-y-3 mb-6">
                    <!-- Les cartes utilis√©es seront inject√©es ici -->
                </div>
                <button onclick="closeCardRepurchaseModal()" class="bg-gray-200 text-gray-700 px-6 py-2 rounded-lg font-semibold">Annuler</button>
            </div>
        </div>
        
        <!-- ======================================= -->
        <!-- NOUVEAU: MODAL Confirmation Joker Destin -->
        <!-- ======================================= -->
        <div id="destin-confirmation-modal" class="hidden fixed inset-0 bg-black/50 backdrop-blur-sm flex items-center justify-center p-6 z-50">
            <div class="bg-base p-6 rounded-2xl shadow-xl max-w-sm w-full text-center">
                <span class="text-5xl">üîÆ</span>
                <h3 class="font-display text-2xl text-rose-800 mt-4 mb-2">Confirmer la Mission</h3>
                <p class="text-gray-700 mb-6">Voulez-vous vraiment lancer cette mission ?</p>
                
                <div class="bg-rose-50 p-4 rounded-lg mb-6 shadow-inner text-left">
                    <h4 class="font-semibold text-rose-800">Mission :</h4>
                    <p class="text-lg font-bold text-rose-900" id="destin-modal-title">...</p>
                    <h4 class="font-semibold text-rose-800 mt-2">Description :</h4>
                    <p class="text-sm text-gray-700" id="destin-modal-description">...</p>
                </div>

                <div class="space-y-3">
                    <button onclick="confirmDestinMission()" class="btn-secondary w-full px-6 py-3 rounded-lg font-semibold">Confirmer ce choix</button>
                    <button onclick="closeDestinConfirmationModal()" class="bg-gray-200 text-gray-700 px-6 py-2 rounded-lg font-semibold">Annuler (Choisir une autre)</button>
                </div>
            </div>
        </div>

        <!-- ======================================= -->
        <!-- NOUVEAU: MODAL Formulaire Secret Love -->
        <!-- ======================================= -->
        <!-- MODIFI√â: Ajout de onclick="closeSecretLoveModal()" sur l'overlay -->
        <div id="secret-love-modal" class="hidden fixed inset-0 bg-black/50 backdrop-blur-sm flex items-center justify-center p-6 z-50" onclick="closeSecretLoveModal()">
            <!-- MODIFI√â: Ajout de onclick="event.stopPropagation()" pour ne pas fermer en cliquant sur le contenu -->
            <div class="bg-base p-6 rounded-2xl shadow-xl max-w-sm w-full" onclick="event.stopPropagation()">
                <div class="text-center">
                    <span class="text-5xl">üåà</span>
                    <h3 class="font-display text-2xl text-rose-800 mt-4 mb-2">Valider une Mission Secr√®te</h3>
                    <p class="text-gray-700 mb-6">Racontez la mission secr√®te que vous avez r√©alis√©e. (Bonus fixe: 15 üíï)</p>
                </div>
                
                <div class="space-y-4">
                    <div>
                        <label for="secret-mission-title" class="text-sm font-semibold text-rose-800">Titre de votre mission</label>
                        <input type="text" id="secret-mission-title" class="w-full p-2 border border-rose-200 rounded-lg mt-1" placeholder="Ex: J'ai pr√©par√© son dessert pr√©f√©r√©">
                    </div>
                    <div>
                        <label for="secret-mission-description" class="text-sm font-semibold text-rose-800">Racontez (sera vu par votre partenaire)</label>
                        <textarea id="secret-mission-description" class="w-full p-2 border border-rose-200 rounded-lg mt-1" rows="3" placeholder="Expliquez ce que vous avez fait..."></textarea>
                    </div>
                    <!-- NOUVEL AJOUT -->
                    <div>
                        <label for="secret-mission-date" class="text-sm font-semibold text-rose-800">Date de la mission (optionnel)</label>
                        <input type="date" id="secret-mission-date" class="w-full p-2 border border-rose-200 rounded-lg mt-1">
                    </div>
                </div>

                <div class="space-y-3 mt-6">
                    <button onclick="confirmSecretMission()" class="btn-secondary w-full px-6 py-3 rounded-lg font-semibold">Valider & Gagner 15 üíï</button>
                    <button onclick="closeSecretLoveModal()" class="bg-gray-200 text-gray-700 px-6 py-2 rounded-lg font-semibold">Annuler</button>
                </div>
            </div>
        </div>

        <!-- ======================================= -->
        <!-- NOUVEAU: MODAL Confirmation Joker Orga -->
        <!-- ======================================= -->
        <div id="orga-confirmation-modal" class="hidden fixed inset-0 bg-black/50 backdrop-blur-sm flex items-center justify-center p-6 z-50">
            <div class="bg-base p-6 rounded-2xl shadow-xl max-w-sm w-full text-center">
                <span class="text-5xl">üïØÔ∏è</span>
                <h3 class="font-display text-2xl text-rose-800 mt-4 mb-2">Annuler la Mission ?</h3>
                <p class="text-gray-700 mb-6">Voulez-vous vraiment utiliser ce joker pour annuler la mission : <br><strong id="orga-modal-mission-theme" class="text-rose-900">...</strong> ?</p>
                
                <div class="space-y-3">
                    <button onclick="confirmCancelMission()" class="btn-secondary w-full px-6 py-3 rounded-lg font-semibold">Oui, annuler la mission</button>
                    <button onclick="closeOrgaConfirmationModal()" class="bg-gray-200 text-gray-700 px-6 py-2 rounded-lg font-semibold">Non, continuer la mission</button>
                </div>
            </div>
        </div>

        <!-- ======================================= -->
        <!-- NOUVEAU: MODAL Confirmation Carte Switch -->
        <!-- ======================================= -->
        <div id="switch-confirmation-modal" class="hidden fixed inset-0 bg-black/50 backdrop-blur-sm flex items-center justify-center p-6 z-50">
            <div class="bg-base p-6 rounded-2xl shadow-xl max-w-sm w-full text-center">
                <span class="text-5xl">üé≤</span>
                <h3 class="font-display text-2xl text-rose-800 mt-4 mb-2">√âchanger les R√¥les ?</h3>
                <p class="text-gray-700 mb-6">Voulez-vous vraiment utiliser cette carte pour √©changer les r√¥les sur la mission : <br><strong id="switch-modal-mission-theme" class="text-rose-900">...</strong> ?</p>
                
                <div class="space-y-3">
                    <button onclick="confirmSwitchMission()" class="btn-secondary w-full px-6 py-3 rounded-lg font-semibold">Oui, √©changer les r√¥les</button>
                    <button onclick="closeSwitchConfirmationModal()" class="bg-gray-200 text-gray-700 px-6 py-2 rounded-lg font-semibold">Non, annuler</button>
                </div>
            </div>
        </div>

    </div> <!-- Fin du conteneur mobile -->


    <script type="module">
        // CORRECTION: Commentaire HTML remplac√© par un commentaire JS
        // Initialisation des sons
        let audioReady = false;
        const clickSynth = new Tone.Synth({ oscillator: { type: 'sine' }, envelope: { attack: 0.01, decay: 0.1, sustain: 0.01, release: 0.1 } }).toDestination();
        const pointSynth = new Tone.Synth({ oscillator: { type: 'triangle' }, envelope: { attack: 0.01, decay: 0.2, sustain: 0.1, release: 0.2 } }).toDestination();
        const rewardSynth = new Tone.Synth({ oscillator: { type: 'sine' }, envelope: { attack: 0.01, decay: 0.5, sustain: 0.1, release: 0.5 } }).toDestination();
        const winSynth = new Tone.Synth().toDestination();

        // Fonction pour initialiser l'audio au premier clic
        async function initAudio() {
            if (audioReady) return;
            await Tone.start();
            audioReady = true;
            console.log('Audio pr√™t.');
        }

        function playSound(type) {
            if (!audioReady) return;
            try {
                const now = Tone.now();
                if (type === 'click') clickSynth.triggerAttackRelease('C5', '8n', now + 0.01);
                if (type === 'point') pointSynth.triggerAttackRelease('G5', '4n', now + 0.01);
                if (type === 'reward') rewardSynth.triggerAttackRelease('C6', '2n', now + 0.01);
                if (type === 'win') winSynth.triggerAttackRelease('C5', '8n', now + 0.1);
            } catch (e) {
                console.error('Erreur audio:', e);
            }
        }
        
        // --- √âtat de l'application (Game State) ---

        // Mod√®les pour un nouvel √©tat joueur
        const missionTemplates = [
            { id: 'A', theme: 'Aventure', status: 'todo', score: 0, photo: null, note: '', description: "Vivre une nouvelle exp√©rience ensemble, m√™me petite.", completedBy: null, mode: null },
            { id: 'B', theme: 'Brunch', status: 'todo', score: 0, photo: null, note: '', description: "Pr√©parer ou partager un petit-d√©jeuner/brunch de rois.", completedBy: null, mode: null },
            { id: 'C', theme: 'Cr√©ativit√©', status: 'todo', score: 0, photo: null, note: '', description: "Faire quelque chose d'artistique : peinture, musique, √©criture...", completedBy: null, mode: null },
            { id: 'D', theme: 'Danse', status: 'todo', score: 0, photo: null, note: '', description: "Une danse impromptue dans le salon ou une soir√©e salsa.", completedBy: null, mode: null },
            { id: 'E', theme: '√âvasion', status: 'todo', score: 0, photo: null, note: '', description: "S'√©chapper de la routine, m√™me pour une heure.", completedBy: null, mode: null },
            { id: 'F', theme: 'Fantaisie', status: 'todo', score: 0, photo: null, note: '', description: "R√©aliser un petit fantasme ou un r√™ve partag√©.", completedBy: null, mode: null },
            { id: 'G', theme: 'Gourmandise', status: 'todo', score: 0, photo: null, note: '', description: "Cuisiner le dessert pr√©f√©r√© de l'autre ou un festin.", completedBy: null, mode: null },
            { id: 'H', theme: 'Humour', status: 'todo', score: 0, photo: null, note: '', description: "Une soir√©e blagues, stand-up ou com√©die.", completedBy: null, mode: null },
            { id: 'I', theme: 'Inattendu', status: 'todo', score: 0, photo: null, note: '', description: "Une surprise totale pour l'autre.", completedBy: null, mode: null },
            { id: 'J', theme: 'Jeu', status: 'todo', score: 0, photo: null, note: '', description: "Soir√©e jeux de soci√©t√©, jeux vid√©o en duo.", completedBy: null, mode: null },
            { id: 'K', theme: 'K√¢lin', status: 'todo', score: 0, photo: null, note: '', description: "Un moment d√©di√© uniquement aux c√¢lins et √† la tendresse.", completedBy: null, mode: null },
            { id: 'L', theme: 'Ludique', status: 'todo', score: 0, photo: null, note: '', description: "Retomber en enfance : parc d'attraction, bataille de polochons...", completedBy: null, mode: null },
            { id: 'M', theme: 'Magie', status: 'todo', score: 0, photo: null, note: '', description: "Cr√©er un moment f√©√©rique : bougies, √©toiles, lieu secret.", completedBy: null, mode: null },
            { id: 'N', theme: 'Nuit', status: 'todo', score: 0, photo: null, note: '', description: "Une balade nocturne, une nuit blanche √† discuter.", completedBy: null, mode: null },
            { id: 'O', theme: 'Os√©', status: 'todo', score: 0, photo: null, note: '', description: "Sortir de sa zone de confort, oser quelque chose de nouveau.", completedBy: null, mode: null },
            { id: 'P', theme: 'Passion', status: 'todo', score: 0, photo: null, note: '', description: "Une soir√©e d√©di√©e √† raviver la flamme.", completedBy: null, mode: null },
            { id: 'Q', theme: 'Quotidien', status: 'todo', score: 0, photo: null, note: '', description: "Rendre un moment banal (courses, m√©nage) extraordinaire.", completedBy: null, mode: null },
            { id: 'R', theme: 'R√™ve', status: 'todo', score: 0, photo: null, note: '', description: "Parler de vos r√™ves communs et en planifier un.", completedBy: null, mode: null },
            { id: 'S', theme: 'Surprise', status: 'todo', score: 0, photo: null, note: '', description: "Un petit cadeau ou une attention non planifi√©e.", completedBy: null, mode: null },
            { id: 'T', theme: 'Tendre', status: 'todo', score: 0, photo: null, note: '', description: "Un √©change de massages, un bain partag√©...", completedBy: null, mode: null },
            { id: 'U', theme: 'Unique', status: 'todo', score: 0, photo: null, note: '', description: "Recr√©er un souvenir unique √† votre histoire.", completedBy: null, mode: null },
            { id: 'V', theme: 'Voyage', status: 'todo', score: 0, photo: null, note: '', description: "Planifier vos prochaines vacances ou un week-end.", completedBy: null, mode: null },
            { id: 'W', theme: 'Week-end', status: 'todo', score: 0, photo: null, note: '', description: "Un week-end parfait, organis√© √† deux.", completedBy: null, mode: null },
            { id: 'X', theme: 'Xtr√™me', status: 'todo', score: 0, photo: null, note: '', description: "Une petite dose d'adr√©naline (sport, d√©fi...)." , completedBy: null, mode: null },
            { id: 'Y', theme: 'Yoga', status: 'todo', score: 0, photo: null, note: '', description: "Un moment de d√©tente et de connexion : yoga ou m√©ditation √† deux.", completedBy: null, mode: null },
            { id: 'Z', theme: 'Z√©nith', status: 'todo', score: 0, photo: null, note: '', description: "Atteindre un sommet, au propre (randonn√©e) ou au figur√©.", completedBy: null, mode: null },
        ];

        const cardTemplates = [
            { id: 'switch', name: 'Switch', effect: '√âchange les r√¥les pour la mission', icon: 'üé≤' },
            { id: 'double', name: 'Double Point', effect: 'Double le score final', icon: 'üíå' },
            { id: 'coeur', name: 'C≈ìur', effect: 'Remplace la mission par un geste d‚Äôamour', icon: 'üíï' },
            { id: 'secret', name: 'Secret Love', effect: 'Cr√©e une mission surprise', icon: 'üåà' },
            { id: 'steal', name: 'Steal My Heart', effect: "Vole une r√©compense '√† utiliser' de l'autre.", icon: 'üî•' },
        ];

        const jokerTemplates = [
            { id: 'orga', name: 'Organisation', effect: 'Passe ton tour d‚Äôorganisation', icon: 'üïØÔ∏è' },
            { id: 'destin', name: 'Destin', effect: 'Choisis ou rejoue une mission aim√©e', icon: 'üîÆ' },
            { id: 'bonus', name: 'Bonus +3', effect: 'Ajoute +3 points au score final', icon: '‚ûï' },
        ];
        
        // Les r√©compenses restent partag√©es / identiques
        const rewardsList = [
            { name: 'üç∞ Douce attention', cost: 10 },
            { name: 'üé¨ Soir√©e choisie', cost: 20 },
            { name: 'üé¥ Rachat de Carte sp√©ciale', cost: 20 },
            { name: 'üçΩÔ∏è D√Æner romantique', cost: 30 },
            { name: 'üå∂Ô∏è Soir√©e Passion', cost: 35 },
            { name: 'üíé Rachat de Joker', cost: 40 },
            { name: 'üõçÔ∏è Petit achat v√™tement', cost: 60 },
            { name: 'üåπ Sortie sp√©ciale', cost: 80 },
            { name: 'üíç Reset Love', cost: 100 },
        ];

        // Liste des modes de jeu (MODIFI√âE)
        const gameModes = ['Tour √† Tour', 'Duo', 'D√©fi secret'];

        // Explications des modes de jeu
        const modeExplanations = {
            'Tour √† Tour': "L'un de vous (d√©sign√© par le jeu) doit organiser ou r√©aliser la mission pour l'autre.",
            'Perla üíÉüèª': "Tour de Perla ! üíÉüèª Perla doit organiser ou r√©aliser cette mission pour Romain.",
            'Romain üï∫üèª': "Tour de Romain ! üï∫üèª Romain doit organiser ou r√©aliser cette mission pour Perla.",
            'Duo': "Mission en tandem ! Vous devez planifier et r√©aliser cette mission ensemble.",
            'D√©fi secret': "Chacun pr√©pare en secret sa version de la mission. Comparez vos r√©sultats √† la fin !",
            'Destin üîÆ': "Vous avez utilis√© un joker pour choisir cette mission. √Ä vous de jouer !",
            'Secret Love üåà': "Une mission surprise cr√©√©e par vous ! √Ä vous de jouer." // NOUVELLE EXPLICATION
        };
        
        // NOUVEAU: Variable helper pour la mission en contexte
        let contextMissionId = null;

        // Fonction pour cr√©er un √©tat de joueur propre
        function createPlayerState(name) {
            return {
                name: name,
                lovePoints: 0,
                activeCard: null,
                activeJoker: null,
                // MODIFI√â: Ajout de la propri√©t√© "quantity"
                cards: JSON.parse(JSON.stringify(cardTemplates)).map(c => ({ ...c, quantity: 1 })),
                jokers: JSON.parse(JSON.stringify(jokerTemplates)).map(j => ({ ...j, quantity: 1 })),
                scoring: { creativite: 0, effort: 0, complicite: 0 },
                purchasedRewards: [] 
            };
        }

        // Nouvel √©tat global (sera charg√© depuis Firebase)
let globalState = null;
let activePlayerState = null;
let onModalCloseCallback = null;

// Fonction pour cr√©er l'√©tat par d√©faut
function createDefaultState() {
    return {
        currentPlayer: null, // 'perla' ou 'romain'
        currentView: 'login',
        previousView: 'login',
        destinMode: false,
        destinMissionIdToConfirm: null,
        tempSecretMissionPhoto: null,
        ongoingMissionId: null,
        lastAlternancePlayer: 'romain',
        actionLog: [], 
        photoGallery: [],
        sharedMissions: JSON.parse(JSON.stringify(missionTemplates)),
        players: {
            perla: createPlayerState("Perla"),
            romain: createPlayerState("Romain")
        }

    };
}
        window.createDefaultState = createDefaultState;

        // --- Fonctions de Navigation ---
        
        function login(playerName) {
            initAudio();
            globalState.destinMode = false; 
            globalState.previousView = 'login'; // NOUVEAU: R√©initialiser
            globalState.currentPlayer = playerName;
            activePlayerState = globalState.players[playerName];
            
            // Appliquer le th√®me
            const appContainer = document.getElementById('app-container');
            appContainer.classList.remove('theme-perla', 'theme-romain'); // MODIFI√â: romain
            appContainer.classList.add(`theme-${playerName}`);
            
            // Mettre √† jour le nom
            document.getElementById('home-welcome-name').innerText = activePlayerState.name;
            
            showView('home');
        }
        window.login = login;

        function logout() {
            globalState.currentPlayer = null;
            activePlayerState = null;
            globalState.destinMode = false; 
            globalState.previousView = 'login'; // NOUVEAU: R√©initialiser
            
            // Retirer le th√®me
            const appContainer = document.getElementById('app-container');
            appContainer.classList.remove('theme-perla', 'theme-romain'); // MODIFI√â: romain
            
            showView('login');
        }
        window.logout = logout;

        // MODIFI√â: Ajout de playNavSound
        function showView(viewId, playNavSound = true) {
            // NOUVEAU: M√©moriser la vue pr√©c√©dente
            if (viewId !== globalState.currentView) {
                globalState.previousView = globalState.currentView;
            }

            if (!globalState.currentPlayer && viewId !== 'login') {
                viewId = 'login'; // Forcer le login si personne n'est connect√©
            }

            // LOGIQUE DE BLOCAGE
            if (viewId === 'ongoing-mission' && globalState.ongoingMissionId) {
                const mission = globalState.sharedMissions.find(m => m.id === globalState.ongoingMissionId);
                if (mission) {
                    // MODIFI√â: Ic√¥nes et nom
                    if (mission.mode.includes('Perla üíÉüèª') && globalState.currentPlayer === 'romain') {
                        showModal('Stop ! ‚õî', "C'est au tour de Perla de g√©rer cette mission.", 'üíÉüèª');
                        if (playNavSound) playSound('click'); 
                        return; // Bloque la navigation
                    }
                    if (mission.mode.includes('Romain üï∫üèª') && globalState.currentPlayer === 'perla') {
                        showModal('Stop ! ‚õî', "C'est au tour de Romain de g√©rer cette mission.", 'üï∫üèª');
                        if (playNavSound) playSound('click'); 
                        return; // Bloque la navigation
                    }
                }
            }
            // FIN DE LA LOGIQUE

            // NOUVEAU: D√©sactiver le mode Destin si on quitte la timeline
            if (globalState.destinMode && viewId !== 'timeline') {
                globalState.destinMode = false;
                console.log('Mode Destin d√©sactiv√© (navigation)');
            }

            // MODIFI√â: Condition pour jouer le son
            if (audioReady && playNavSound) playSound('click');
            
            document.querySelectorAll('#app-container > div').forEach(div => {
                div.classList.add('hidden');
            });
            document.getElementById(`view-${viewId}`).classList.remove('hidden');
            globalState.currentView = viewId;
            
            // Mettre √† jour les vues sp√©cifiques quand on les charge
            if (activePlayerState) {
                if (viewId === 'home') updateHomeUI();
                if (viewId === 'timeline') renderTimeline();
                if (viewId === 'new-mission') setupWheels();
                if (viewId === 'mission-briefing') renderBriefing(); // NOUVEAU
                if (viewId === 'ongoing-mission') renderOngoingMission(); 
                if (viewId === 'bank') renderBank();
                if (viewId === 'cards') renderCards();
                if (viewId === 'jokers') renderJokers();
                if (viewId === 'mailbox') renderMailbox(); 
                if (viewId === 'gallery') renderGallery(); // NOUVEAU
            }
        }
        window.showView = showView; // Exposer la fonction √† onclick

        // --- Fonctions de Rendu (UI) ---
        
        function updateHomeUI() {
            // Solde banque du joueur ACTIF
            const activePoints = activePlayerState.lovePoints;
            document.getElementById('home-love-bank').innerText = activePoints;
            
            // Progression Perla
            const perlaPoints = globalState.players.perla.lovePoints;
            const perlaProgress = Math.min((perlaPoints / 100) * 100, 100);
            document.getElementById('home-progress-bar-perla').style.width = `${perlaProgress}%`;
            document.getElementById('home-progress-text-perla').innerText = perlaPoints;
            
            // Progression Romain (MODIFI√â)
            const romainPoints = globalState.players.romain.lovePoints;
            const romainProgress = Math.min((romainPoints / 100) * 100, 100);
            document.getElementById('home-progress-bar-romain').style.width = `${romainProgress}%`;
            document.getElementById('home-progress-text-romain').innerText = romainPoints;
            
            // G√©rer le bouton "Mission en Cours"
            const ongoingBtn = document.getElementById('ongoing-mission-btn');
            if (globalState.ongoingMissionId) {
                ongoingBtn.disabled = false;
            } else {
                ongoingBtn.disabled = true;
            }
            
            // Mettre √† jour les souvenirs (depuis la timeline partag√©e)
            const souvenirsContainer = document.getElementById('home-souvenirs');
            souvenirsContainer.innerHTML = '';
            const missionsDone = globalState.sharedMissions.filter(m => m.status === 'done' && m.photo);
            
            if(missionsDone.length === 0) {
                souvenirsContainer.innerHTML = '<p class="text-sm text-gray-500 italic">Commencez une mission pour ajouter un souvenir...</p>';
            } else {
                missionsDone.reverse().slice(0, 5).forEach(m => { // 5 plus r√©cents
                    souvenirsContainer.innerHTML += `
                        <img src="${m.photo}" alt="${m.theme}" class="w-20 h-20 rounded-lg object-cover shadow-sm cursor-pointer" onclick="showMissionDetail('${m.id}')">
                    `;
                });
            }
        }

        function renderTimeline() {
            const grid = document.getElementById('timeline-grid');
            grid.innerHTML = '';
            // Lecture depuis la timeline partag√©e
            globalState.sharedMissions.forEach(m => {
                let bgColor = 'bg-white hover:bg-rose-50';
                let textColor = 'text-gray-400';
                let borderColor = 'border-gray-200';
                let completionMark = `...`; // Default
                
                if (m.status === 'inprogress') {
                    bgColor = 'bg-rose-100 hover:bg-rose-200';
                    textColor = 'text-rose-600';
                    borderColor = 'border-rose-300';
                } else if (m.status === 'done') {
                    bgColor = 'bg-secondary hover:bg-yellow-300';
                    textColor = 'text-rose-900 font-bold';
                    borderColor = 'border-yellow-400';
                    // MODIFI√â: Romain
                    const initial = m.completedBy === 'Perla' ? 'P' : (m.completedBy === 'Romain' ? 'R' : '');
                    completionMark = `${m.score}üíï (${initial})`;
                }
                
                grid.innerHTML += `
                    <button onclick="showMissionDetail('${m.id}')" class="${bgColor} ${borderColor} w-16 h-16 rounded-full flex flex-col items-center justify-center text-center shadow-md border-2 transition-all">
                        <span class="font-display text-2xl ${textColor}">${m.id}</span>
                        <span class="text-xs ${textColor} -mt-1">${completionMark}</span>
                    </button>
                `;
            });
        }

        // NOUVEAU: Rendu de la Boite aux Lettres
        function renderMailbox() {
            const container = document.getElementById('mailbox-log');
            container.innerHTML = '';
            
            if (globalState.actionLog.length === 0) {
                container.innerHTML = '<p class="text-center text-gray-500 italic p-8">Votre histoire commence ici... Lancez une mission !</p>';
                return;
            }

            globalState.actionLog.forEach(item => {
                // Si c'est une lettre d'amour
                if (item.type === 'letter') {
                    container.innerHTML += `
                        <div class="p-4 bg-rose-50 border border-rose-200 rounded-lg shadow-md">
                            <div class="flex justify-between items-center mb-3 pb-2 border-b border-rose-200">
                                <span class="font-semibold text-rose-800">${item.icon} ${item.player} a √©crit :</span>
                                <span class="text-xs text-gray-500">${item.timestamp}</span>
                            </div>
                            <p class="text-gray-700 italic whitespace-pre-wrap">${item.letterContent}</p>
                        </div>
                    `;
                } 
                // NOUVEAU: Si c'est une demande de r√©compense
                else if (item.type === 'reward_request') {
                    // MODIFI√â: V√©rifie si la demande a √©t√© trait√©e
                    if (item.processed) {
                        // Rendu "Trait√©"
                        container.innerHTML += `
                            <div class="p-4 bg-gray-100 border border-gray-200 rounded-lg shadow-sm opacity-60">
                                <div class="flex justify-between items-center mb-2 pb-2 border-b border-gray-200">
                                    <span class="font-semibold text-gray-600">${item.icon} DEMANDE TRAIT√âE</span>
                                    <span class="text-xs text-gray-500">${item.timestamp}</span>
                                </div>
                                <p class="text-gray-500 italic line-through">
                                    <span class="font-bold">${item.player}</span> ${item.message}
                                </p>
                            </div>
                        `;
                    } else {
                        // Rendu "Urgent / √Ä Traiter"
                        container.innerHTML += `
                            <div class="p-4 bg-yellow-50 border-2 border-yellow-300 rounded-lg shadow-md">
                                <div class="flex justify-between items-center mb-2 pb-2 border-b border-yellow-200">
                                    <span class="font-semibold text-yellow-800">${item.icon} DEMANDE DE R√âCOMPENSE</span>
                                    <span class="text-xs text-gray-500">${item.timestamp}</span>
                                </div>
                                <p class="text-gray-700 font-semibold">
                                    <!-- MODIFI√â: Romain -->
                                    <span class="font-bold ${item.player === 'Perla' ? 'text-rose-800' : 'text-blue-800'}">${item.player}</span> ${item.message}
                                </p>
                                <!-- NOUVEAU BOUTON -->
                                <button onclick="processRewardRequest(${item.id})" class="btn-secondary w-full mt-3 py-2 text-sm font-bold">
                                    Marquer comme "Fait" ‚úÖ
                                </button>
                            </div>
                        `;
                    }
                }
                // Si c'est une action normale
                else {
                    container.innerHTML += `
                        <div class="p-3 bg-white border border-gray-100 rounded-lg flex items-center gap-3 shadow-sm">
                            <span class="text-2xl">${item.icon}</span>
                            <div class="flex-1">
                                <p class="text-sm text-gray-700">
                                    <span class="font-semibold text-rose-800">${item.player}</span> ${item.message}
                                </p>
                                <span class="text-xs text-gray-400">${item.timestamp}</span>
                            </div>
                        </div>
                    `;
                }
            });
        }
        
        // NOUVELLE FONCTION: Rendu de la Galerie
        function renderGallery() {
            const grid = document.getElementById('gallery-grid');
            const emptyMsg = document.getElementById('gallery-empty');
            grid.innerHTML = '';
            
            if (globalState.photoGallery.length === 0) {
                emptyMsg.classList.remove('hidden');
                grid.classList.add('hidden');
            } else {
                emptyMsg.classList.add('hidden');
                grid.classList.remove('hidden');
                
                // .reverse() pour montrer les plus r√©centes en premier
                [...globalState.photoGallery].reverse().forEach(photo => {
                    grid.innerHTML += `
                        <div class="aspect-square bg-gray-100 rounded-lg overflow-hidden">
                            <img src="${photo.src}" alt="Souvenir ${photo.missionId}" class="w-full h-full object-cover cursor-pointer" onclick="showModal('Souvenir de ${photo.theme}', '${photo.note || ''}', 'üñºÔ∏è')">
                        </div>
                    `;
                });
            }
        }
        
        function renderBank() {
            const points = activePlayerState.lovePoints;
            const progress = Math.min((points / 100) * 100, 100);
            
            document.getElementById('bank-total-points').innerText = points;
            document.getElementById('bank-progress-bar').style.width = `${progress}%`;
            document.getElementById('bank-progress-text').innerText = points;
            
            // --- NOUVEAU: Rendu de l'inventaire ---
            const inventoryList = document.getElementById('purchased-rewards-inventory');
            inventoryList.innerHTML = '';
            const purchased = activePlayerState.purchasedRewards;
            
            if (purchased.length === 0) {
                inventoryList.innerHTML = '<p class="text-sm text-gray-500 italic text-center p-4 bg-gray-50 rounded-lg">Aucune r√©compense en attente. Achetez-en une ci-dessous !</p>';
            } else {
                purchased.forEach(r => {
                    inventoryList.innerHTML += `
                        <div class="flex justify-between items-center p-4 bg-white rounded-lg shadow-sm border ${r.consumed ? 'border-gray-200 opacity-60' : 'border-rose-200'}">
                            <div>
                                <span class="font-semibold ${r.consumed ? 'text-gray-500 line-through' : 'text-rose-800'}">${r.name}</span>
                                <span class="text-sm text-gray-500 block">${r.consumed ? 'Consomm√©e' : '√Ä utiliser'}</span>
                            </div>
                            <!-- Simple bouton "Consomm√©" -->
                            <button onclick="toggleRewardConsumed(${r.id})" class="${r.consumed ? 'bg-gray-200 text-gray-700' : 'btn-primary'} px-4 py-2 rounded-lg font-semibold text-sm">
                                ${r.consumed ? '‚úì' : 'Consommer'}
                            </button>
                        </div>
                    `;
                });
            }

            // --- Rendu de la boutique (comme avant) ---
            const list = document.getElementById('rewards-list');
            list.innerHTML = '';
            rewardsList.forEach(r => {
                let canBuy = points >= r.cost;
                const isReset = r.name.includes('Reset Love');
                // const isJokerRepurchase = r.name.includes('Rachat de Joker'); // N'est plus n√©cessaire
                // const isCardRepurchase = r.name.includes('Rachat de Carte'); // N'est plus n√©cessaire

                // NOTE: Les v√©rifications de quantit√© ont √©t√© retir√©es.
                // Vous pouvez acheter des rachats tant que vous avez des points.
                
                if (isReset && points < 100) return;
                
                list.innerHTML += `
                    <div class="flex justify-between items-center p-4 bg-white rounded-lg shadow-sm border ${canBuy ? 'border-yellow-200' : 'border-gray-200'}">
                        <div>
                            <span class="font-semibold ${isReset ? 'text-accent' : 'text-rose-800'}">${r.name}</span>
                            <span class="text-sm text-gray-500 block">${r.cost} pts</span>
                        </div>
                        <button onclick="buyReward('${r.name}', ${r.cost})" class="${canBuy ? (isReset ? 'btn-secondary' : 'btn-primary') : 'bg-gray-200 text-gray-500 cursor-not-allowed'} px-4 py-2 rounded-lg font-semibold text-sm" ${!canBuy ? 'disabled' : ''}>
                            ${isReset ? 'Valider üåπ' : 'Acheter'}
                        </button>
                    </div>
                `;
            });
        }
        
        function renderCards() {
            const grid = document.getElementById('cards-grid');
            grid.innerHTML = '';
            activePlayerState.cards.forEach(c => {
                const quantity = c.quantity; // NOUVEAU
                const isDepleted = c.quantity === 0; // MODIFI√â
                const isActive = activePlayerState.activeCard === c.id;
                
                grid.innerHTML += `
                    <div class="p-4 bg-white rounded-xl shadow-lg border ${isActive ? 'border-yellow-500 ring-2 ring-yellow-300' : 'border-rose-100'} ${isDepleted ? 'opacity-50' : ''} relative">
                        <!-- NOUVEAU: Badge de Quantit√© -->
                        ${quantity > 0 ? `<span class="absolute top-2 right-2 bg-secondary text-rose-900 text-xs font-bold px-2 py-1 rounded-full z-10">x${quantity}</span>` : ''}
                        
                        <span class="text-4xl">${c.icon}</span>
                        <h3 class="font-display text-xl font-bold text-rose-800 mt-2">${c.name}</h3>
                        <p class="text-sm text-gray-600 h-16">${c.effect}</p>
                        <button onclick="activateCard('${c.id}')" class="w-full mt-3 ${isActive ? 'btn-secondary' : 'btn-primary'} px-4 py-2 rounded-lg font-semibold text-sm" ${isDepleted && !isActive ? 'disabled' : ''}>
                            <!-- MODIFI√â: Logique du bouton -->
                            ${isActive ? 'Activ√©e' : (isDepleted ? '√âpuis√©' : 'Activer')}
                        </button>
                    </div>
                `;
            });
        }
        
        function renderJokers() {
            const grid = document.getElementById('jokers-grid');
            grid.innerHTML = '';
            activePlayerState.jokers.forEach(j => {
                const quantity = j.quantity; // NOUVEAU
                const isDepleted = j.quantity === 0; // MODIFI√â
                const isActive = activePlayerState.activeJoker === j.id;
                
                grid.innerHTML += `
                    <div class="p-4 bg-white rounded-xl shadow-lg border ${isActive ? 'border-yellow-500 ring-2 ring-yellow-300' : 'border-rose-100'} ${isDepleted ? 'opacity-50' : ''} relative">
                        <!-- NOUVEAU: Badge de Quantit√© -->
                        ${quantity > 0 ? `<span class="absolute top-2 right-2 bg-secondary text-rose-900 text-xs font-bold px-2 py-1 rounded-full z-10">x${quantity}</span>` : ''}

                        <span class="text-4xl">${j.icon}</span>
                        <h3 class="font-display text-xl font-bold text-rose-800 mt-2">${j.name}</h3>
                        <p class="text-sm text-gray-600 h-16">${j.effect}</p>
                        <button onclick="activateJoker('${j.id}')" class="w-full mt-3 ${isActive ? 'btn-secondary' : 'btn-primary'} px-4 py-2 rounded-lg font-semibold text-sm" ${isDepleted && !isActive ? 'disabled' : ''}>
                            <!-- MODIFI√â: Logique du bouton -->
                            ${isActive ? 'Activ√©' : (isDepleted ? '√âpuis√©' : 'Activer')}
                        </button>
                    </div>
                `;
            });
        }

        // --- Fonctions de Logique (Mission, Score) ---

        // NOUVEAU: Rendu du Briefing
        function renderBriefing() {
            if (!globalState.ongoingMissionId) {
                // S'il n'y a pas de mission, on ne devrait pas √™tre ici. Retour.
                showView('home');
                return;
            }
            
            const mission = globalState.sharedMissions.find(m => m.id === globalState.ongoingMissionId);
            
            document.getElementById('briefing-title').innerText = `${mission.id}: ${mission.theme}`;
            document.getElementById('briefing-description').innerText = mission.description;
            document.getElementById('briefing-mode').innerText = mission.mode;
            document.getElementById('briefing-mode-explanation').innerText = modeExplanations[mission.mode] || "Vivez ce moment comme vous le sentez !";
        }
        
        // NOUVEAU: Fonction pour la vue "Mission en Cours"
        function renderOngoingMission() {
            const noMissionDiv = document.getElementById('no-ongoing-mission');
            const missionContentDiv = document.getElementById('ongoing-mission-content');
            
            if (!globalState.ongoingMissionId) {
                // Pas de mission en cours
                noMissionDiv.classList.remove('hidden');
                missionContentDiv.classList.add('hidden');
                contextMissionId = null;
            } else {
                // Une mission est en cours
                noMissionDiv.classList.add('hidden');
                missionContentDiv.classList.remove('hidden');
                
                contextMissionId = globalState.ongoingMissionId; // Mettre √† jour le contexte
                const mission = globalState.sharedMissions.find(m => m.id === contextMissionId);
                
                document.getElementById('mission-ongoing-title').innerText = `${mission.id}: ${mission.theme}`;
                document.getElementById('mission-ongoing-mode').innerText = mission.mode;
                // NOUVEL AJOUT
                document.getElementById('mission-ongoing-mode-explanation').innerText = modeExplanations[mission.mode] || "Vivez ce moment comme vous le sentez !";
                
                document.getElementById('mission-ongoing-description').innerText = mission.description;
                document.getElementById('mission-ongoing-photo-preview').src = mission.photo || 'https://placehold.co/600x400/FADADD/8B4513?text=Ajouter+une+photo';
                
                const noteEl = document.getElementById('mission-ongoing-note');
                noteEl.value = mission.note;
                // Mettre √† jour le state en temps r√©el
                noteEl.oninput = (e) => { mission.note = e.target.value; };

                // Mettre √† jour les bonus actifs
                const bonusContainer = document.getElementById('ongoing-mission-bonuses');
                bonusContainer.innerHTML = '';
                let hasBonus = false;

                if (activePlayerState.activeCard) {
                    const card = activePlayerState.cards.find(c => c.id === activePlayerState.activeCard);
                    if (card) {
                        bonusContainer.innerHTML += `
                            <div class="flex items-center gap-2 text-green-700 font-semibold">
                                <span class="text-2xl">${card.icon}</span>
                                <span>Carte active: ${card.name}</span>
                            </div>
                        `;
                        hasBonus = true;
                    }
                }
                
                if (activePlayerState.activeJoker) {
                    const joker = activePlayerState.jokers.find(j => j.id === activePlayerState.activeJoker);
                    if (joker) {
                        bonusContainer.innerHTML += `
                            <div class="flex items-center gap-2 text-blue-700 font-semibold">
                                <span class="text-2xl">${joker.icon}</span>
                                <span>Joker actif: ${joker.name}</span>
                            </div>
                        `;
                        hasBonus = true;
                    }
                }

                if (!hasBonus) {
                    bonusContainer.innerHTML = '<p class="text-sm text-gray-500 italic">Aucun bonus actif pour cette mission.</p>';
                }
            }
        }
        
        // C'est la vitrine (clic depuis la Timeline)
        function showMissionDetail(missionId) {
            
            // --- NOUVELLE LOGIQUE POUR LE JOKER DESTIN ---
            if (globalState.destinMode) {
                const mission = globalState.sharedMissions.find(m => m.id === missionId);
                
                // C-1: Mission en cours, on bloque
                if (mission.status === 'inprogress') {
                    showModal('Mission Bloqu√©e', 'Cette mission est d√©j√† en cours.', 'ü§∑‚Äç‚ôÄÔ∏è');
                    return; // Ne rien faire
                }

                // C-2: Mission "√Ä Faire" ou "Faite" (NOUVELLE LOGIQUE DE PR√âVISUALISATION)
                if (mission.status === 'todo' || mission.status === 'done') {
                    
                    const joker = activePlayerState.jokers.find(j => j.id === 'destin');
                    if (joker.quantity === 0) {
                         showModal('Oups !', 'Vous n\'avez plus de joker Destin.', 'üò•');
                         globalState.destinMode = false; // D√©sactiver le mode
                         return;
                    }
                    
                    // NOUVEAU: Ouvre le modal de confirmation au lieu de lancer
                    globalState.destinMissionIdToConfirm = mission.id;
                    document.getElementById('destin-modal-title').innerText = `${mission.id}: ${mission.theme}`;
                    document.getElementById('destin-modal-description').innerText = mission.description;
                    document.getElementById('destin-confirmation-modal').classList.remove('hidden');
                    return; // Stoppe l'ex√©cution ici
                }
            }
            // --- FIN DE LA LOGIQUE DESTIN ---

            // --- Code original (Vitrine) ---
            contextMissionId = missionId; // Mettre √† jour le contexte
            const mission = globalState.sharedMissions.find(m => m.id === missionId);
            
            document.getElementById('mission-title').innerText = `${mission.id}: ${mission.theme}`;
            document.getElementById('mission-description').innerText = mission.description;
            document.getElementById('mission-photo-preview').src = mission.photo || 'https://placehold.co/600x400/FADADD/8B4513?text=Ajouter+une+photo';
            document.getElementById('mission-mode').innerText = mission.mode || "Non d√©fini";
            
            const noteEl = document.getElementById('mission-note');
            noteEl.value = mission.note;
            // Mettre √† jour le state en temps r√©el
            noteEl.oninput = (e) => { mission.note = e.target.value; };

            // Boutons de statut (visuel seulement)
            const statusContainer = document.getElementById('mission-status-buttons');
            statusContainer.innerHTML = '';
            // MODIFI√â: Ne montre plus "todo"
            if (mission.status === 'inprogress') {
                statusContainer.innerHTML += `<button class="px-4 py-2 rounded-lg font-semibold text-sm bg-rose-200 text-rose-700" disabled>En Cours</button>`;
            } else if (mission.status === 'done') {
                statusContainer.innerHTML += `<button class="px-4 py-2 rounded-lg font-semibold text-sm bg-yellow-300 text-rose-800" disabled>Fait !</button>`;
            }
            
            // Le bouton "Noter" est cach√© par d√©faut dans le HTML
            showView('mission');
        }
        window.showMissionDetail = showMissionDetail;
        
        // NOUVELLE FONCTION: Confirmation du Joker Destin
        function confirmDestinMission() {
            const missionId = globalState.destinMissionIdToConfirm;
            if (!missionId) return;
            
            const mission = globalState.sharedMissions.find(m => m.id === missionId);
            const joker = activePlayerState.jokers.find(j => j.id === 'destin');

            // Logique de lancement (copi√©e de l'ancienne fonction showMissionDetail)
            let logMessage = `a utilis√© le joker Destin pour choisir : ${mission.id}: ${mission.theme}.`;
            let modalMessage = `Votre nouvelle mission est ${mission.id}: ${mission.theme}. Allez dans "Mission enCours" pour la commencer.`;
            let briefingMode = 'Destin üîÆ';

            // Si la mission √©tait "Faite", on la r√©initialise
            if (mission.status === 'done') {
                if (mission.photo) {
                    addPhotoToGallery(mission, "Ancien souvenir (avant Joker Destin üîÆ)");
                }
                
                // MODIFI√â: Correctif pour les missions B‚òÖ
                const template = missionTemplates.find(t => t.id === missionId);
                mission.photo = null;
                mission.note = '';
                mission.score = 0;
                mission.completedBy = null;
                // R√©initialise la description seulement si ce n'est pas une mission bonus
                if (template) {
                    mission.description = template.description; 
                }
                logMessage = `a utilis√© le joker Destin pour **refaire** : ${mission.id}: ${mission.theme}.`;
                modalMessage = `Vous avez choisi de **refaire** la mission ${mission.id}: ${mission.theme}. Elle est r√©initialis√©e et pr√™te dans "Mission en Cours".`;
            }

            // Lancement de la mission
            playSound('reward');
            globalState.ongoingMissionId = mission.id;
            mission.status = 'inprogress';
            mission.mode = briefingMode; // Mode sp√©cial
            globalState.destinMode = false; // D√©sactiver le mode
            joker.quantity--; // Consomme le joker
            
            logAction(activePlayerState.name, 'üîÆ', logMessage);
            
            closeDestinConfirmationModal(); // Ferme le modal de confirmation
            
            showModal(
                'Mission Choisie !',
                modalMessage, // Message mis √† jour
                'üîÆ',
                () => showView('mission-briefing') // VA AU BRIEFING
            );
            renderJokers(); // Mettre √† jour l'UI des jokers
            globalState.destinMissionIdToConfirm = null; // Nettoyer
        }
        window.confirmDestinMission = confirmDestinMission;
        
        // NOUVELLE FONCTION: Fermer le modal de confirmation Destin
        function closeDestinConfirmationModal() {
            playSound('click');
            globalState.destinMissionIdToConfirm = null; // Nettoyer
            document.getElementById('destin-confirmation-modal').classList.add('hidden');
        }
        window.closeDestinConfirmationModal = closeDestinConfirmationModal;

        // NOUVELLE FONCTION: Fermer le modal de confirmation Orga
        function closeOrgaConfirmationModal() {
            playSound('click');
            document.getElementById('orga-confirmation-modal').classList.add('hidden');
        }
        window.closeOrgaConfirmationModal = closeOrgaConfirmationModal;

        // NOUVELLE FONCTION: Confirmation du Joker Orga
        function confirmCancelMission() {
            playSound('click');
            const mission = globalState.sharedMissions.find(m => m.id === globalState.ongoingMissionId);
            const joker = activePlayerState.jokers.find(j => j.id === 'orga');

            joker.quantity--; // 1. Consommer le joker
            logAction(activePlayerState.name, joker.icon, `a utilis√© le joker Organisation pour annuler la mission : ${mission.theme}.`); // 2. Logger

            // 3. R√©initialiser la mission
            mission.status = 'todo';
            mission.mode = null; // Nettoyer le mode
            
            // 4. Nettoyer l'√©tat global
            globalState.ongoingMissionId = null;
            contextMissionId = null;

            renderJokers(); // 5. Mettre √† jour l'UI des jokers
            closeOrgaConfirmationModal(); // 6. Fermer le modal
            showModal(
                'Mission Annul√©e',
                'La mission a √©t√© annul√©e et le joker consomm√©. Vous pouvez lancer une nouvelle mission.',
                'üïØÔ∏è',
                () => showView('home') // 7. Retour √† l'accueil
            );
        }
        window.confirmCancelMission = confirmCancelMission;

        // NOUVELLE FONCTION: Fermer le modal de confirmation Switch
        function closeSwitchConfirmationModal() {
            playSound('click');
            document.getElementById('switch-confirmation-modal').classList.add('hidden');
        }
        window.closeSwitchConfirmationModal = closeSwitchConfirmationModal;

        // NOUVELLE FONCTION: Confirmation de la Carte Switch
        function confirmSwitchMission() {
            // playSound('click'); // CORRECTION: Supprim√© pour √©viter le double son
            const mission = globalState.sharedMissions.find(m => m.id === globalState.ongoingMissionId);
            const card = activePlayerState.cards.find(c => c.id === 'switch');

            if (mission.mode.includes('Perla üíÉüèª')) {
                mission.mode = 'Romain üï∫üèª';
                globalState.lastAlternancePlayer = 'perla'; 
                card.quantity--;
                logAction(activePlayerState.name, 'üé≤', `a utilis√© la carte Switch ! La mission est pass√©e √† Romain.`);
                closeSwitchConfirmationModal();
                showModal('Switch !', 'La mission est maintenant assign√©e √† Romain !', 'üé≤', () => {
                    showView('home');
                });
            } else if (mission.mode.includes('Romain üï∫üèª')) {
                mission.mode = 'Perla üíÉüèª';
                globalState.lastAlternancePlayer = 'romain'; 
                card.quantity--;
                logAction(activePlayerState.name, 'üé≤', `a utilis√© la carte Switch ! La mission est pass√©e √† Perla.`);
                closeSwitchConfirmationModal();
                showModal('Switch !', 'La mission est maintenant assign√©e √† Perla !', 'üé≤', () => {
                    showView('home');
                });
            }
            
            if (globalState.currentView === 'ongoing-mission') {
                renderOngoingMission();
            }
            renderCards(); // Re-render la liste des cartes
        }
        window.confirmSwitchMission = confirmSwitchMission;

        // NOUVELLE FONCTION: Fermer le modal Secret Love
        function closeSecretLoveModal() {
            playSound('click');
            document.getElementById('secret-love-modal').classList.add('hidden');
        }
        window.closeSecretLoveModal = closeSecretLoveModal;
        
        // NOUVELLE FONCTION: Confirmer la mission Secret Love
        // MODIFICATION MAJEURE: Ne cr√©e plus de mission, donne 15 points.
        function confirmSecretMission() {
            const title = document.getElementById('secret-mission-title').value;
            const description = document.getElementById('secret-mission-description').value;
            const date = document.getElementById('secret-mission-date').value; // NOUVEL AJOUT
            
            if (!title || !description) {
                showModal('Oups !', 'Vous devez remplir un titre et une description pour votre mission secr√®te.', 'üò•');
                return;
            }

            // 1. Consommer la carte
            const card = activePlayerState.cards.find(c => c.id === 'secret');
            if (card.quantity === 0) { // Double v√©rification
                showModal('Erreur', 'Vous n\'avez plus de carte Secret Love.', 'üò•');
                return;
            }
            card.quantity--;

            // 2. Ajouter 15 points
            activePlayerState.lovePoints += 15;
            
            // 3. Logger l'action (en gardant le secret)
            // MODIFI√â: Ajout de la date au message
            let logMessage = `a organis√© une mission "Secret Love" ! (+15 üíï)`;
            if (date) {
                // Formate la date pour √™tre plus lisible
                const formattedDate = new Date(date).toLocaleDateString('fr-FR', { day: 'numeric', month: 'long', year: 'numeric' });
                logMessage = `a organis√© une mission "Secret Love" pour le ${formattedDate} ! (+15 üíï)`;
            }
            logAction(activePlayerState.name, 'üåà', logMessage, 'log', null);
            
            // 4. Confirmer et retourner √† l'accueil
            closeSecretLoveModal();
            showModal(
                'Mission Secr√®te R√©ussie !',
                `Vous gagnez 15 üíï ! Votre partenaire verra l'action dans la Bo√Æte aux Lettres.`,
                'üåà',
                () => showView('home') // Aller √† l'accueil
            );
            
            renderCards(); // Mettre √† jour l'UI des cartes
        }
        window.confirmSecretMission = confirmSecretMission;


        // N'est plus utilis√©, mais on le garde au cas o√π
        function updateMissionStatus(missionId, status) {
            playSound('click');
            const mission = globalState.sharedMissions.find(m => m.id === missionId);
            mission.status = status;
            showMissionDetail(missionId); // Re-render
        }
        window.updateMissionStatus = updateMissionStatus;
        
        function previewMissionPhoto(event) {
            const file = event.target.files[0];
            if (file && contextMissionId) { // Utilise le helper de contexte
                const reader = new FileReader();
                reader.onload = function(e) {
                    const imgUrl = e.target.result;
                    // Mettre √† jour la mission dans le state
                    const mission = globalState.sharedMissions.find(m => m.id === contextMissionId);
                    mission.photo = imgUrl;
                    
                    // Mettre √† jour uniquement la vue "en cours" (CORRIG√â)
                    const previewOngoing = document.getElementById('mission-ongoing-photo-preview');
                    if (previewOngoing) previewOngoing.src = imgUrl;
                }; // <-- FIN DE reader.onload
                reader.readAsDataURL(file);
            }
        } // <-- FIN DE previewMissionPhoto
        window.previewMissionPhoto = previewMissionPhoto;

        // --- Logique de Rating (√âtoiles) ---
        function setRating(criteria, value) {
            playSound('click');
            activePlayerState.scoring[criteria] = value;
            
            // CORRECTION: Logique simplifi√©e et robuste avec les nouveaux IDs
            const parentDiv = document.getElementById(`stars-${criteria}`);
            
            if(parentDiv) {
                parentDiv.querySelectorAll('span').forEach(star => {
                    if (parseInt(star.dataset.value) <= value) {
                        star.classList.remove('opacity-30');
                    } else {
                        star.classList.add('opacity-30');
                    }
                });
            }
        }
        window.setRating = setRating;
        
        // --- Logique de Scoring ---
        
        function setupScoring() {
            activePlayerState.scoring = { creativite: 0, effort: 0, complicite: 0 };
            document.querySelectorAll('#view-score [data-value]').forEach(star => star.classList.add('opacity-30'));
            document.querySelectorAll('#view-score input[type="checkbox"]').forEach(check => check.checked = false);
            
            const bonusInfo = document.getElementById('score-bonus-info');
            bonusInfo.innerHTML = '';
            if (activePlayerState.activeJoker === 'bonus') {
                bonusInfo.innerHTML += '<p class="text-green-600">Joker Bonus +3 appliqu√© ! üíé</p>';
            }
            if (activePlayerState.activeCard === 'double') {
                bonusInfo.innerHTML += '<p class="text-green-600">Carte Double Point appliqu√©e ! üíå</p>';
            }
        }
        
        // NOUVEAU: Fonction pour y acc√©der depuis "Mission en Cours"
        function goToScoringFromOngoing() {
            const mission = globalState.sharedMissions.find(m => m.id === globalState.ongoingMissionId);
            if (mission.status === 'done') {
                showModal('D√©j√† Fait', 'Cette mission a d√©j√† √©t√© not√©e.', 'üòÖ');
                return;
            }
            setupScoring();
            showView('score');
        }
        window.goToScoringFromOngoing = goToScoringFromOngoing;
        
        // N'est plus utilis√©, mais on le garde au cas o√π
        function showScoringScreen() {
            const mission = globalState.sharedMissions.find(m => m.id === globalState.ongoingMissionId);
            if (mission.status === 'done') {
                showModal('D√©j√† Fait', 'Cette mission a d√©j√† √©t√© not√©e.', 'üòÖ');
                return;
            }
            setupScoring();
            showView('score');
        }
        window.showScoringScreen = showScoringScreen;
        
        function calculateScore() {
            // Utilise l'ID global de la mission en cours
            const missionId = globalState.ongoingMissionId;
            if (!missionId) {
                showModal('Erreur', 'Aucune mission en cours √† noter.', 'ü§∑‚Äç‚ôÄÔ∏è');
                showView('home');
                return;
            }

            let baseScore = activePlayerState.scoring.creativite + activePlayerState.scoring.effort + activePlayerState.scoring.complicite;
            let bonusScore = 0;
            
            if (document.getElementById('bonus-photo').checked) bonusScore += 1;
            if (document.getElementById('bonus-surprise').checked) bonusScore += 1;
            if (document.getElementById('bonus-ambiance').checked) bonusScore += 2;
            if (document.getElementById('bonus-twist').checked) bonusScore += 2;
            if (document.getElementById('bonus-express').checked) bonusScore += 1;
            
            let totalScore = baseScore + bonusScore;
            
            // Appliquer Joker +3
            if (activePlayerState.activeJoker === 'bonus') {
                const joker = activePlayerState.jokers.find(j => j.id === 'bonus');
                // MODIFI√â: V√©rifie la quantit√©
                if (joker && joker.quantity > 0) {
                    totalScore += 3;
                    joker.quantity--; // D√©cr√©mente
                    logAction(activePlayerState.name, joker.icon, `a utilis√© le joker ${joker.name}.`);
                }
                activePlayerState.activeJoker = null;
            }
            
            // Appliquer Carte Double Point
            if (activePlayerState.activeCard === 'double') {
                const card = activePlayerState.cards.find(c => c.id === 'double');
                // MODIFI√â: V√©rifie la quantit√©
                if (card && card.quantity > 0) {
                    totalScore *= 2;
                    card.quantity--; // D√©cr√©mente
                    logAction(activePlayerState.name, card.icon, `a utilis√© la carte ${card.name}.`);
                }
                activePlayerState.activeCard = null;
            }
            
            // Mettre √† jour la mission (sur la timeline partag√©e)
            const mission = globalState.sharedMissions.find(m => m.id === missionId);
            mission.score = totalScore;
            mission.status = 'done';
            // Lit la note depuis la vue "en cours"
            mission.note = document.getElementById('mission-ongoing-note').value;
            mission.completedBy = activePlayerState.name; 
            
            // NOUVEL AJOUT: Sauvegarder la photo dans la galerie
            if (mission.photo) {
                addPhotoToGallery(mission);
            }
            
            // Mettre √† jour la banque (personnelle)
            activePlayerState.lovePoints += totalScore;
            
            playSound('point');
            
            // NOUVEAU: Log d'action
            logAction(activePlayerState.name, 'üßÆ', `a termin√© la mission ${mission.id} et a gagn√© ${totalScore} üíï.`);

            // R√©initialiser la mission en cours
            globalState.ongoingMissionId = null;
            contextMissionId = null;

            // Afficher modal de score
            showModal('Score Enregistr√© !', `Vous gagnez ${totalScore} üíï ! Votre nouveau solde est de ${activePlayerState.lovePoints} üíï.`, 'üíñ');
            
            // Retour √† l'accueil
            showView('home');
        }
        window.calculateScore = calculateScore;

        // --- Logique Cartes & Jokers ---
        
        function activateCard(cardId) {
            playSound('click');
            const card = activePlayerState.cards.find(c => c.id === cardId);
            
            // MODIFI√â: Permet de d√©sactiver, mais pas d'activer si √©puis√©
            if (card.quantity === 0 && cardId !== activePlayerState.activeCard) return; 

            // --- LOGIQUE "SWITCH" ---
            if (cardId === 'switch') {
                if (!globalState.ongoingMissionId) {
                    showModal('Oups !', 'Vous devez √™tre dans une mission pour utiliser cette carte.', 'üòÖ');
                    return;
                }
                const mission = globalState.sharedMissions.find(m => m.id === globalState.ongoingMissionId);

                // MODIFI√â: V√©rifie si c'est bien un tour √† tour
                if (!mission.mode.includes('Perla üíÉüèª') && !mission.mode.includes('Romain üï∫üèª')) {
                    showModal('Oups !', 'Cette carte ne fonctionne que sur les missions "Tour √† Tour".', 'üò•');
                    return; // Ne pas utiliser la carte
                }
                
                // MODIFI√â: Ouvre le modal de confirmation au lieu d'ex√©cuter
                document.getElementById('switch-modal-mission-theme').innerText = `"${mission.theme}"`;
                document.getElementById('switch-confirmation-modal').classList.remove('hidden');

                return; // Important: on sort, on attend la confirmation
            }
            // --- FIN LOGIQUE "SWITCH" ---
            
            
            // --- LOGIQUE "COEUR" ---
            if (cardId === 'coeur') {
                if (!globalState.ongoingMissionId) {
                    showModal('Oups !', 'Vous devez √™tre dans une mission pour utiliser cette carte.', 'üòÖ');
                    return;
                }
                // const card = activePlayerState.cards.find(c => c.id === 'coeur'); // D√©j√† trouv√©
                if (card.quantity === 0) return; // MODIFI√â
                
                // C'est une action imm√©diate, on va √† l'√©cran d'√©criture
                showView('love-letter', false); 
                return; // Sortir de la fonction
            }
            // --- FIN LOGIQUE "COEUR" ---
            
            // --- NOUVELLE LOGIQUE "STEAL MY HEART" ---
            if (cardId === 'steal') {
                // const card = activePlayerState.cards.find(c => c.id === 'steal'); // D√©j√† trouv√©
                if (card.quantity === 0) return; // MODIFI√â

                const victimName = globalState.currentPlayer === 'perla' ? 'romain' : 'perla';
                const victimState = globalState.players[victimName];
                const rewardsToSteal = victimState.purchasedRewards.filter(r => !r.consumed);

                if (rewardsToSteal.length === 0) {
                    showModal('Oups !', `Votre partenaire (${victimState.name}) n'a aucune r√©compense √† voler pour le moment.`, 'ü§∑‚Äç‚ôÄÔ∏è');
                    return;
                }
                
                // Pr√©parer et afficher la vue de vol
                const listContainer = document.getElementById('steal-reward-list');
                listContainer.innerHTML = '';
                rewardsToSteal.forEach(r => {
                    listContainer.innerHTML += `
                        <button onclick="stealReward(${r.id}, '${victimName}')" class="btn-primary w-full p-4 rounded-lg text-left font-semibold">
                            ${r.name}
                        </button>
                    `;
                });
                
                showView('steal-reward', false); // MODIFI√â: playNavSound = false
                return; // Sortir de la fonction
            }
            // --- FIN LOGIQUE "STEAL" ---
            
            // --- NOUVELLE LOGIQUE "SECRET LOVE" ---
            // CORRECTION: Bloc dupliqu√© et if non ferm√© supprim√©s
            if (cardId === 'secret') {
                // MODIFI√â: Logique pour ouvrir le formulaire
                /* == BLOCAGE RETIR√â ==
                   Le 'if' suivant est comment√© pour vous permettre d'utiliser
                   la carte Secret Love m√™me si une mission est en cours.
                
                if (globalState.ongoingMissionId) {
                    showModal('Oups !', 'Terminez votre mission en cours avant d\'en cr√©er une nouvelle.', 'üòÖ');
                    return;
                }
                */
                if (card.quantity === 0) {
                     return; // D√©j√† √©puis√©
                }
                
                // Ouvre le formulaire de cr√©ation
                document.getElementById('secret-mission-title').value = '';
                document.getElementById('secret-mission-description').value = '';
                document.getElementById('secret-love-modal').classList.remove('hidden');
                
                // La carte sera consomm√©e √† la validation du formulaire
                return; // Sortir
            }
            // --- FIN LOGIQUE "SECRET LOVE" ---


            // Logique pour les autres cartes (toggle)
            if (activePlayerState.activeCard === cardId) {
                activePlayerState.activeCard = null;
            } else {
                activePlayerState.activeCard = cardId;
                // 'coeur', 'steal' et 'secret' sont retir√©s de cette liste
                if (cardId === 'double') { 
                    // ... (logique 'double')
                }
            }
            renderCards(); 
        }
        window.activateCard = activateCard;
        
        // --- NOUVELLE FONCTION: Logique de Vol ---
        function stealReward(rewardId, victimName) {
            playSound('reward');
            
            const victimState = globalState.players[victimName];
            
            // 1. Trouver et retirer la r√©compense de la victime
            const rewardIndex = victimState.purchasedRewards.findIndex(r => r.id === rewardId);
            if (rewardIndex === -1) {
                showModal('Erreur', 'Cette r√©compense n\'existe plus.', 'üò•');
                showView('home', false); // MODIFI√â: playNavSound = false
                return;
            }
            const [stolenReward] = victimState.purchasedRewards.splice(rewardIndex, 1);
            
            // 2. Ajouter la r√©compense au voleur
            activePlayerState.purchasedRewards.push(stolenReward);
            
            // 3. Marquer la carte "Steal" comme utilis√©e
            const stealCard = activePlayerState.cards.find(c => c.id === 'steal');
            stealCard.quantity--; // MODIFI√â
            
            // 4. Logger l'action
            logAction(activePlayerState.name, 'üî•', `a vol√© la r√©compense "${stolenReward.name}" √† ${victimState.name} !`); // MODIFI√â: Romain
            
            // 5. Confirmer et retourner √† l'accueil
            showModal(
                'Vol R√©ussi !',
                `Vous avez vol√© la r√©compense "${stolenReward.name}" ! Elle est maintenant dans votre inventaire.`,
                'üî•',
                () => showView('home')
            );
        }
        window.stealReward = stealReward;

        function activateJoker(jokerId) {
            playSound('click');
            const joker = activePlayerState.jokers.find(j => j.id === jokerId);
            // MODIFI√â: Permet de d√©sactiver, mais pas d'activer si √©puis√©
            if (joker.quantity === 0 && jokerId !== activePlayerState.activeJoker) return; 

            if (jokerId === 'bonus') {
                if (activePlayerState.activeJoker === jokerId) {
                    activePlayerState.activeJoker = null;
                } else {
                    activePlayerState.activeJoker = jokerId;
                }
            } 
            // NOUVELLE LOGIQUE POUR DESTIN
            else if (jokerId === 'destin') {
                if (globalState.ongoingMissionId) {
                    showModal('Oups !', 'Terminez votre mission en cours avant d\'en choisir une nouvelle avec ce joker.', 'üòÖ');
                    return;
                }
                
                // NOUVEAU: V√©rifier la quantit√© avant d'activer
                if (joker.quantity === 0) {
                    showModal('Oups !', 'Vous n\'avez plus de joker Destin.', 'üò•');
                    return;
                }
                
                // On n'utilise pas le joker tout de suite, seulement quand la mission est choisie
                globalState.destinMode = true; // Activer le mode
                logAction(activePlayerState.name, joker.icon, `active le joker ${joker.name}.`);
                
                showModal(
                    'Mode Destin Activ√© !', 
                    'Allez sur la Timeline (A‚ÜíZ) et choisissez la mission que vous souhaitez lancer.', 
                    'üîÆ',
                    () => showView('timeline') // Naviguer vers la timeline
                );
            }
            // FIN LOGIQUE DESTIN
            // NOUVELLE LOGIQUE POUR 'ORGA'
            else if (jokerId === 'orga') {
                if (!globalState.ongoingMissionId) {
                    showModal('Oups !', 'Vous devez avoir une mission en cours pour utiliser ce joker.', 'üòÖ');
                    return; // Ne rien faire, ne pas consommer
                }
                
                const mission = globalState.sharedMissions.find(m => m.id === globalState.ongoingMissionId);

                // MODIFI√â: Ouvre le modal de confirmation d√©di√©
                document.getElementById('orga-modal-mission-theme').innerText = `"${mission.theme}"`;
                document.getElementById('orga-confirmation-modal').classList.remove('hidden');
                
                return; // Important: on sort, on attend la confirmation
            }
            // FIN LOGIQUE 'ORGA'
            else { 
                // Logique pour 'orga' (actuellement: consommer)
                // showModal('Joker Activ√©', `Le joker ${joker.name} a √©t√© utilis√© !`, 'üíé');
                // joker.quantity--; 
                // activePlayerState.activeJoker = null; 
                // logAction(activePlayerState.name, joker.icon, `a utilis√© le joker ${joker.name}.`); 
                console.warn(`Joker non g√©r√©: ${jokerId}`);
            }
            renderJokers(); 
        }
        window.activateJoker = activateJoker;

        // --- Logique de la Roue ---
        
        function setupWheels() {
            const letterWheel = document.getElementById('wheel-letter');
            const modeWheel = document.getElementById('wheel-mode');
            
            letterWheel.style.transition = 'none';
            modeWheel.style.transition = 'none';
            letterWheel.style.transform = 'translateY(0)';
            modeWheel.style.transform = 'translateY(0)';
            
            document.getElementById('spin-button').classList.remove('hidden');

            letterWheel.innerHTML = '';
            // MODIFI√â: N'affiche que les 26 lettres de base
            const letters = missionTemplates.filter(m => !m.id.startsWith('B‚òÖ')).map(m => m.id);
            const repeatedLetters = [...letters, ...letters, ...letters]; 
            repeatedLetters.forEach(letter => {
                letterWheel.innerHTML += `<div class="wheel-item h-[50px]">${letter}</div>`;
            });
            
            modeWheel.innerHTML = '';
            const repeatedModes = [...gameModes, ...gameModes, ...gameModes, ...gameModes];
            repeatedModes.forEach(mode => {
                modeWheel.innerHTML += `<div class="wheel-item h-[50px]">${mode}</div>`;
            });
        }
        
        function spinWheels() {
            playSound('click');
            
            if (globalState.ongoingMissionId) {
                showModal('Oups !', 'Terminez votre mission en cours avant d\'en lancer une nouvelle.', 'üòÖ');
                return;
            }
            
            // MODIFI√â: Ne compte que les 26 missions de base
            const availableMissions = globalState.sharedMissions.filter(m => m.status !== 'done' && !m.id.startsWith('B‚òÖ'));
            if (availableMissions.length === 0) {
                showModal('Bravo !', 'Vous avez compl√©t√© toutes les missions A-Z ! Il est temps pour le Reset Love üåπ (ou cr√©ez une mission "Secret Love" !)', 'üéâ');
                return;
            }
            
            const selectedMission = availableMissions[Math.floor(Math.random() * availableMissions.length)];
            const selectedMode = gameModes[Math.floor(Math.random() * gameModes.length)];
            
            // LOGIQUE D'ALTERNANCE
            let finalModeToSave = selectedMode;
            
            if (selectedMode === 'Tour √† Tour') {
                // MODIFI√â: Romain + Ic√¥nes
                if (globalState.lastAlternancePlayer === 'romain') {
                    finalModeToSave = 'Perla üíÉüèª';
                    globalState.lastAlternancePlayer = 'perla';
                } else {
                    finalModeToSave = 'Romain üï∫üèª';
                    globalState.lastAlternancePlayer = 'romain';
                }
            }
            
            // Sauver les choix
            globalState.ongoingMissionId = selectedMission.id;
            const mission = globalState.sharedMissions.find(m => m.id === selectedMission.id);
            mission.status = 'inprogress';
            mission.mode = finalModeToSave; 
            
            // Calculer l'arr√™t de la roue
            const letterWheel = document.getElementById('wheel-letter');
            const modeWheel = document.getElementById('wheel-mode');
            
            // MODIFI√â: Index bas√© sur les 26 lettres
            const letterIndex = missionTemplates.findIndex(m => m.id === selectedMission.id) + 26; 
            const letterPosition = -(letterIndex * 50) + 25; 
            
            const modeIndex = gameModes.indexOf(selectedMode) + (gameModes.length * 2); 
            const modePosition = -(modeIndex * 50) + 25;
            
            // Appliquer la transition et le spin
            letterWheel.style.transition = 'transform 3s cubic-bezier(0.33, 1, 0.68, 1)';
            modeWheel.style.transition = 'transform 3.5s cubic-bezier(0.33, 1, 0.68, 1)'; 
            
            letterWheel.style.transform = `translateY(${letterPosition}px)`;
            modeWheel.style.transform = `translateY(${modePosition}px)`;
            
            // NOUVELLE LOGIQUE: Montrer un modal et rediriger
            document.getElementById('spin-button').classList.add('hidden');
            setTimeout(() => {
                playSound('reward'); 
                logAction(activePlayerState.name, 'üé≤', `a lanc√© la mission ${mission.id}: ${mission.theme} (Mode: ${mission.mode})`);
                
                // MODIFI√â: Redirige vers le briefing
                showModal(
                    'Mission Lanc√©e !', 
                    `Votre nouvelle mission est :\n${mission.id}: ${mission.theme}\n(Mode: ${mission.mode})`, 
                    'üé≤',
                    () => showView('mission-briefing') // VA AU BRIEFING
                );
            }, 3500); // Apr√®s la fin du spin le plus long
        }
        window.spinWheels = spinWheels;
        
        // N'est plus utilis√©
        function startMissionFromWheel() {
            showView('ongoing-mission');
        }
        window.startMissionFromWheel = startMissionFromWheel;
        
        // --- Envoyer la lettre d'amour ---
        function sendLoveLetter() {
            const text = document.getElementById('love-letter-text').value;
            if (text.trim().length < 10) {
                showModal('Oups !', 'Mettez-y un peu plus de c≈ìur ! (10 caract√®res min)', 'üò•');
                return;
            }
            
            const missionId = globalState.ongoingMissionId;
            const mission = globalState.sharedMissions.find(m => m.id === missionId);
            const card = activePlayerState.cards.find(c => c.id === 'coeur');

            // 1. Mettre √† jour la mission
            mission.note = "üíå Lettre d'Amour üíå\n\n" + text;
            mission.status = 'done';
            mission.score = 10; // Score fixe
            mission.completedBy = activePlayerState.name;
            mission.mode = "Lettre d'Amour üíå"; 
            
            // 2. Mettre √† jour le joueur
            activePlayerState.lovePoints += 10; // Points gagn√©s
            card.quantity--; // MODIFI√â
            
            // 3. R√©initialiser l'√©tat global
            globalState.ongoingMissionId = null;
            contextMissionId = null;
            
            // 4. Confirmer et naviguer
            playSound('reward');
            // NOUVEAU: Log d'action (type 'letter')
            logAction(activePlayerState.name, 'üíå', `a √©crit une lettre d'amour pour remplacer la mission.`, 'letter', text);
            
            showModal(
                'Lettre Envoy√©e !', 
                'Vous gagnez 10 üíï. Votre partenaire la d√©couvrira dans la Boite aux Lettres.', // Message mis √† jour
                'üíå', 
                () => showView('home') // Retour √† l'accueil
            );
        }
        window.sendLoveLetter = sendLoveLetter;

        // --- Logique Banque & R√©compenses ---

        function repurchaseJoker(jokerId) {
            const cost = 40; 
            if (activePlayerState.lovePoints < cost) {
                showModal('Oups !', 'Points insuffisants.', 'üò•');
                return;
            }

            const joker = activePlayerState.jokers.find(j => j.id === jokerId);
            if (joker) {
                joker.quantity++; // MODIFI√â
                activePlayerState.lovePoints -= cost; 
                playSound('reward');
                closeJokerRepurchaseModal();
                logAction(activePlayerState.name, 'üíé', `a rachet√© le joker ${joker.name}.`); // NOUVEAU
                showModal('Rachat Effectu√©', `Le joker ${joker.name} est √† nouveau disponible ! (Total: x${joker.quantity})`, 'üíé');
                renderBank(); 
            }
        }
        window.repurchaseJoker = repurchaseJoker; 

        // NOUVELLE FONCTION: Racheter une carte sp√©cifique
        function repurchaseCard(cardId) {
            const cost = 20; // Co√ªt d√©fini dans la liste
            if (activePlayerState.lovePoints < cost) {
                showModal('Oups !', 'Points insuffisants.', 'üò•');
                return;
            }

            const card = activePlayerState.cards.find(c => c.id === cardId);
            if (card) {
                card.quantity++; // MODIFI√â
                activePlayerState.lovePoints -= cost; 
                playSound('reward');
                closeCardRepurchaseModal();
                logAction(activePlayerState.name, 'üé¥', `a rachet√© la carte ${card.name}.`);
                showModal('Rachat Effectu√©', `La carte ${card.name} est √† nouveau disponible ! (Total: x${card.quantity})`, 'üé¥'); // Message mis √† jour
                renderBank(); 
            }
        }
        window.repurchaseCard = repurchaseCard; // Exposer

        function buyReward(name, cost) {
            if (activePlayerState.lovePoints < cost) {
                showModal('Oups !', 'Points insuffisants pour acheter cette r√©compense.', 'üò•');
                return;
            }
            
            // On enl√®ve les points TOUT DE SUITE, sauf pour les modals
            if (!name.includes('Rachat')) {
                activePlayerState.lovePoints -= cost;
            }
            
            playSound('reward');

            if (name.includes('Rachat de Carte')) {
                
                // NOUVELLE LOGIQUE: Ouvre le modal de s√©lection
                // MODIFI√â: V√©rification de la quantit√© retir√©e
                showCardRepurchaseModal(); // NOUVELLE FONCTION
                return; // Stoppe buyReward ici

            } else if (name.includes('Rachat de Joker')) {
                // MODIFI√â: V√©rification de la quantit√© retir√©e
                showJokerRepurchaseModal();
                return; 
            } else if (name.includes('Reset Love')) {
                logAction(activePlayerState.name, 'üåπ', `s'appr√™te √† valider le Reset Love...`); // NOUVEAU
                showView('reset-love', false); // MODIFI√â: playNavSound = false
                return; 
            } else {
                // MODIFI√â: Logique pour ajouter √† l'inventaire
                const newReward = {
                    id: Date.now(), // ID unique
                    name: name,
                    cost: cost,
                    consumed: false
                };
                activePlayerState.purchasedRewards.push(newReward);
                
                logAction(activePlayerState.name, 'üéÅ', `a achet√© la r√©compense : ${name}.`); // NOUVEAU
                showModal('R√©compense Achet√©e !', `Vous avez d√©bloqu√© : ${name}. Elle est dans votre inventaire.`, 'üéÅ');
            }
            
            renderBank(); 
        }
        window.buyReward = buyReward;
        
        // --- NOUVELLE FONCTION: G√©rer l'inventaire ---
        function toggleRewardConsumed(rewardId) {
            playSound('click');
            const reward = activePlayerState.purchasedRewards.find(r => r.id === rewardId);
            if (reward) {
                reward.consumed = !reward.consumed; // Basculer l'√©tat
                if(reward.consumed) {
                    // MODIFI√â: Cr√©e un log de type 'reward_request'
                    logAction(activePlayerState.name, 'üö©', `demande √† utiliser la r√©compense : ${reward.name} !`, 'reward_request');
                } else {
                    // Optionnel: On pourrait logguer l'annulation si besoin
                }
            }
            renderBank(); // Re-rendre la banque pour afficher le changement
        }
        window.toggleRewardConsumed = toggleRewardConsumed;

        function tryShowResetLove() {
            if(activePlayerState.lovePoints >= 100) {
                showView('reset-love');
            } else {
                showModal('Pas encore !', `Continuez votre voyage ! Il vous manque ${100 - activePlayerState.lovePoints}üíï pour le Reset Love.`, 'üåπ');
            }
        }
        window.tryShowResetLove = tryShowResetLove;

        function completeResetLove() {
            playSound('win');
            
            // NOUVEAU: Log d'action
            logAction(activePlayerState.name, 'üèÜ', `a compl√©t√© le Reset Love ! Une nouvelle saison commence.`);

            showModal(
                `F√©licitations ${activePlayerState.name} !`, 
                'Vous avez compl√©t√© votre Roroad to Love üíû. Une nouvelle saison commence, pleine de nouveaux souvenirs √† cr√©er.', 
                'üéâ'
            );
            
            const playerName = globalState.currentPlayer;
            // R√©initialise l'√©tat du joueur
            globalState.players[playerName] = createPlayerState(playerName);
            activePlayerState = globalState.players[playerName];
            
            // R√©initialise l'√©tat partag√© (sauf le log)
            globalState.sharedMissions = JSON.parse(JSON.stringify(missionTemplates));
            globalState.ongoingMissionId = null; 
            globalState.lastAlternancePlayer = 'romain'; // MODIFI√â: Romain
            // La galerie (photoGallery) et le log (actionLog) NE SONT PAS r√©initialis√©s
            
            showView('home', false); // MODIFI√â: playNavSound = false
        }
        window.completeResetLove = completeResetLove;

        // --- NOUVELLE FONCTION DE NAVIGATION RETOUR ---
        function goBack() {
            // MODIFI√â: Utilise la vue pr√©c√©dente m√©moris√©e
            const targetView = globalState.previousView || 'home';
            showView(targetView);
        }
        window.goBack = goBack;

        // --- NOUVELLE FONCTION: Traiter une demande de r√©compense ---
        function processRewardRequest(logId) {
            playSound('click');
            const logEntry = globalState.actionLog.find(item => item.id === logId);
            if (logEntry && !logEntry.processed) {
                logEntry.processed = true;
                // Ajoute une confirmation dans le log
                logAction(activePlayerState.name, '‚úÖ', `a trait√© la demande : "${logEntry.message}"`);
                renderMailbox(); // Re-render la bo√Æte
            }
        }
        window.processRewardRequest = processRewardRequest;

        // NOUVELLE FONCTION: Ajout √† la galerie
        function addPhotoToGallery(mission, noteOverride = null) {
             globalState.photoGallery.push({
                id: Date.now(),
                src: mission.photo,
                missionId: mission.id,
                theme: mission.theme,
                note: noteOverride || mission.note || `Souvenir de la mission ${mission.theme}`
            });
        }

        // --- NOUVELLE FONCTION: Log d'Action ---
        function logAction(player, icon, message, type = 'log', letterContent = null) {
            const logEntry = {
                id: Date.now(), // NOUVEAU: ID unique pour chaque entr√©e
                timestamp: new Date().toLocaleString('fr-FR', { day:'2-digit', month: '2-digit', hour: '2-digit', minute: '2-digit' }),
                player: player,
                icon: icon,
                message: message,
                type: type,
                letterContent: letterContent
            };
            
            // NOUVEAU: Ajoute un statut aux demandes de r√©compense
            if (type === 'reward_request') {
                logEntry.processed = false;
            }
            
            // unshift() ajoute au d√©but du tableau (plus r√©cent en haut)
            globalState.actionLog.unshift(logEntry);
        }

        // --- Fonctions Modale ---
        
        function showModal(title, message, icon, onFermerCallback = null) { 
            document.getElementById('modal-title').innerText = title;
            document.getElementById('modal-message').innerText = message;
            document.getElementById('modal-icon').innerText = icon;
            onModalCloseCallback = onFermerCallback; 
            document.getElementById('modal-overlay').classList.remove('hidden');
        }

        function showJokerRepurchaseModal() {
            const list = document.getElementById('joker-repurchase-list');
            list.innerHTML = '';
            // MODIFI√â: Affiche tous les jokers, pas seulement ceux √† 0
            const allJokers = activePlayerState.jokers; 

            if (allJokers.length === 0) { // Ne devrait jamais arriver
                showModal('Oups !', 'Erreur, aucun joker trouv√©.', 'ü§∑‚Äç‚ôÄÔ∏è');
                return;
            }
            
            allJokers.forEach(joker => {
                list.innerHTML += `
                    <button onclick="repurchaseJoker('${joker.id}')" class="btn-primary w-full p-3 rounded-lg flex items-center gap-3 hover:bg-rose-200">
                        <span class="text-3xl">${joker.icon}</span>
                        <!-- NOUVEAU: Affiche la quantit√© actuelle -->
                        <span class="font-semibold text-left">${joker.name} (Actuel: x${joker.quantity})</span>
                    </button>
                `;
            });

            document.getElementById('joker-repurchase-modal').classList.remove('hidden'); // CORRECTION: .add('hidden') -> .remove('hidden')
        }

        // NOUVELLE FONCTION: Montre le modal de rachat de carte
        function showCardRepurchaseModal() {
            const list = document.getElementById('card-repurchase-list');
            list.innerHTML = '';
            // MODIFI√â: Affiche toutes les cartes, pas seulement celles √† 0
            const allCards = activePlayerState.cards; 

            if (allCards.length === 0) { // Ne devrait jamais arriver
                showModal('Oups !', 'Erreur, aucune carte trouv√©e.', 'ü§∑‚Äç‚ôÄÔ∏è');
                return;
            }
            
            allCards.forEach(card => {
                list.innerHTML += `
                    <button onclick="repurchaseCard('${card.id}')" class="btn-primary w-full p-3 rounded-lg flex items-center gap-3 hover:bg-rose-200">
                        <span class="text-3xl">${card.icon}</span>
                        <!-- NOUVEAU: Affiche la quantit√© actuelle -->
                        <span class="font-semibold text-left">${card.name} (Actuel: x${card.quantity})</span>
                    </button>
                `;
            });

            document.getElementById('card-repurchase-modal').classList.remove('hidden');
        }

        function closeJokerRepurchaseModal() {
            playSound('click');
            document.getElementById('joker-repurchase-modal').classList.add('hidden');
        }
        window.closeJokerRepurchaseModal = closeJokerRepurchaseModal; 
        
        // NOUVELLE FONCTION: Ferme le modal de rachat de carte
        function closeCardRepurchaseModal() {
            playSound('click');
            document.getElementById('card-repurchase-modal').classList.add('hidden');
        }
        window.closeCardRepurchaseModal = closeCardRepurchaseModal; 
        
        
        // --- D√©marrage de l'application ---
        document.addEventListener('DOMContentLoaded', () => {
            document.getElementById('modal-close-btn').addEventListener('click', () => {
                // playSound('click'); // CORRECTION: Supprim√© pour √©viter le double son
                document.getElementById('modal-overlay').classList.add('hidden');
                
                if (onModalCloseCallback) {
                    onModalCloseCallback();
                    onModalCloseCallback = null; // Le r√©initialiser
                }
            });

            showView('login'); // D√©marrer sur l'√©cran de login
        });

    </script>
<script type="module">
  // =====================================
  // IMPORT DU SYST√àME DE SAUVEGARDE
  // =====================================
  
  import { enableAutoSave } from './firebase-autosave.js';

  // =====================================
  // ACTIVATION DE LA SAUVEGARDE AUTO
  // =====================================
  
  console.log('üîß Activation de la sauvegarde automatique...');

  // Cr√©er l'√©tat par d√©faut
  const defaultState = window.createDefaultState();

  enableAutoSave(defaultState).then(proxiedState => {
    // Assigner l'√©tat charg√© depuis Firebase
    window.globalState = proxiedState;
    
    // Mettre √† jour activePlayerState si un joueur est connect√©
    if (window.globalState.currentPlayer) {
      window.activePlayerState = window.globalState.players[window.globalState.currentPlayer];
      console.log(`üë§ Joueur actif: ${window.globalState.currentPlayer}`);
    }
    
    // Afficher la vue actuelle
    const currentView = window.globalState.currentView || 'login';
    window.showView(currentView, false);
    
    console.log('‚úÖ Application pr√™te avec sauvegarde automatique !');
  }).catch(error => {
    console.error('‚ùå Erreur lors de l\'activation de la sauvegarde:', error);
    alert('‚ö†Ô∏è La sauvegarde automatique n\'a pas pu √™tre activ√©e.');
    
    // Fallback : utiliser l'√©tat local
    window.globalState = defaultState;
    window.showView('login', false);
  });
</script>
</body>
</html>













